<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>全校學生名單 - 跳繩平台</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body {
            background: #f5f6fa;
            font-family: 'Microsoft JhengHei', Arial, sans-serif;
        }
        .class-title {
            background: #2339d6;
            color: #fff;
            font-weight: bold;
            font-size: 1.2rem;
            text-align: center;
            padding: 8px 0;
            border-radius: 6px 6px 0 0;
            margin-bottom: 0;
            letter-spacing: 2px;
        }
        .student-list-col {
            background: #fff;
            border-radius: 0 0 12px 12px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.06);
            padding: 0 0 20px 0;
            margin-bottom: 24px;
        }
        .student-item {
            text-align: center;
            margin: 18px 0;
        }
        .student-photo {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            object-fit: cover;
            border: 3px solid #3b82f6;
            box-shadow: 0 2px 8px rgba(59,130,246,0.12);
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .student-photo:hover {
            transform: scale(1.08);
            box-shadow: 0 4px 16px rgba(59,130,246,0.25);
        }
        .student-name {
            font-weight: 500;
            margin-top: 8px;
            font-size: 1.08rem;
        }

        @media (max-width: 991px) {
            .class-title { font-size: 1rem; }
            .student-photo { width: 64px; height: 64px; }
        }
        @media (max-width: 767px) {
            .student-list-col { margin-bottom: 16px; }
        }
        
        /* 手機響應式設計 - 按比例顯示 */
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .row {
                flex-wrap: wrap;
                margin: 0;
            }
            
            /* 手機上每行顯示2個學生 */
            .col-lg-2, .col-md-4, .col-6 {
                flex: 0 0 50%;
                max-width: 50%;
                padding: 4px;
            }
            
            .student-list-col {
                margin: 0 0 8px 0;
                border-radius: 8px;
            }
            
            .class-title {
                font-size: 0.9rem;
                padding: 6px 0;
                letter-spacing: 1px;
            }
            
            .student-item {
                margin: 8px 0;
            }
            
            .student-photo {
                width: 50px;
                height: 50px;
                border-width: 2px;
            }
            
            .student-name {
                font-size: 0.9rem;
                margin-top: 4px;
            }
            

            
            /* 移除拖拉相關元素 */
            .scroll-hint, .scroll-indicator {
                display: none;
            }
        }
        
        /* 超小螢幕 - 每行顯示1個學生 */
        @media (max-width: 480px) {
            .col-lg-2, .col-md-4, .col-6 {
                flex: 0 0 100%;
                max-width: 100%;
            }
            
            .student-photo {
                width: 60px;
                height: 60px;
            }
            
            .student-name {
                font-size: 1rem;
            }
            
            /* 班級篩選器在小螢幕上的樣式 */
            #classFilter {
                gap: 4px !important;
            }
            
            #classFilter .btn {
                font-size: 0.8rem;
                padding: 4px 8px;
            }
        }
        
        /* 班級篩選器樣式 */
        #classFilter .btn {
            transition: all 0.3s ease;
            border-radius: 20px;
        }
        
        #classFilter .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        
        #classFilter .btn.active {
            background: #2339d6;
            border-color: #2339d6;
            color: white;
        }
    </style>
</head>
<body>
    <div class="container py-4">
        <h2 class="mb-4 fw-bold text-center" style="color:#2339d6;letter-spacing:2px;">全校學生名單</h2>
        
        <!-- 班級篩選器 -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="d-flex flex-wrap justify-content-center gap-2" id="classFilter">
                    <button class="btn btn-outline-primary btn-sm active" data-class="all">
                        <i class="fas fa-users me-1"></i>全部班級
                    </button>
                    <!-- 班級按鈕動態生成 -->
                </div>
            </div>
        </div>
        
        <div class="row" id="studentsListRow">
            <!-- 學生名單動態生成 -->
        </div>
        
        <div class="text-center mt-4">
            <a href="index.html" class="btn btn-secondary"><i class="fas fa-arrow-left me-2"></i>返回首頁</a>
        </div>
    </div>
    <script>
    // 假資料，實際可從後端獲取
    const studentsData = [
        {
            class: '高中三',
            students: [
                { name: '朱耀鋒', id: '', photo: '' }
            ]
        },
        {
            class: '高中一',
            students: [
                { name: '林思恒', id: '', photo: '' },
                { name: '蘇南燊', id: '', photo: '' }
            ]
        },
        {
            class: '初中四',
            students: [
                { name: '葉芷汝', id: '', photo: '' }
            ]
        },
        {
            class: '初中三',
            students: [
                { name: '吳諾暉', id: '', photo: '' },
                { name: '梁珀源', id: '', photo: '' }
            ]
        },
        {
            class: '高小五',
            students: [
                { name: '黎溢鉦', id: '', photo: '' }
            ]
        },
        {
            class: '高小四',
            students: [
                { name: '黃泳鈺', id: '', photo: '' }
            ]
        },
        {
            class: '高小三',
            students: [
                { name: '楊洛謙', id: '', photo: '' },
                { name: '麥浩敏', id: '', photo: '' },
                { name: '謝韶謙', id: '', photo: '' },
                { name: '馮樂宏', id: '', photo: '' }
            ]
        },
        {
            class: '高小二',
            students: [
                { name: '曾業淳', id: '', photo: '' },
                { name: '馮鎮泓', id: '', photo: '' }
            ]
        },
        {
            class: '高小一',
            students: [
                { name: '倪灝', id: '', photo: '' }
            ]
        },
        {
            class: '初小三',
            students: [
                { name: '林澤星', id: '', photo: '' },
                { name: '蔡瀚毅', id: '', photo: '' },
                { name: '楊凱琳', id: '', photo: '' },
                { name: '龍正罡', id: '', photo: '' }
            ]
        },
        {
            class: '初小二',
            students: [
                { name: '許明然', id: '', photo: '' }
            ]
        }
    ];

    // 自動為所有學生補上唯一 id（1~200 依序遞增）
    (function assignStudentIds() {
        let idCounter = 1;
        studentsData.forEach(cls => {
            cls.students.forEach(stu => {
                stu.id = idCounter.toString().padStart(3, '0');
                idCounter++;
            });
        });
    })();

    // 載入已儲存的學生相片
    function loadStudentPhotos() {
        const saved = localStorage.getItem('studentPhotos');
        if (saved) {
            const savedData = JSON.parse(saved);
            // 建立一個 id->photo 的對照表
            const photoMap = {};
            savedData.forEach(cls => {
                cls.students.forEach(stu => {
                    if (stu.id && stu.photo) {
                        photoMap[stu.id] = stu.photo;
                    }
                });
            });
            // 合併相片資料
            studentsData.forEach(cls => {
                cls.students.forEach(stu => {
                    if (photoMap[stu.id]) {
                        stu.photo = photoMap[stu.id];
                    }
                });
            });
        }
    }

    // 動態生成學生名單
    function renderStudentList(selectedClass = 'all') {
        const row = document.getElementById('studentsListRow');
        row.innerHTML = ''; // 清空現有內容
        
        studentsData.forEach(cls => {
            // 如果選擇了特定班級且不匹配，則跳過
            if (selectedClass !== 'all' && cls.class !== selectedClass) {
                return;
            }
            
            const col = document.createElement('div');
            col.className = 'col-lg-2 col-md-4 col-6 student-list-col';
            col.setAttribute('data-class', cls.class);
            col.innerHTML = `<div class="class-title">${cls.class}</div>`;
            cls.students.forEach(stu => {
                const photoSrc = stu.photo && stu.photo !== '' ? stu.photo : 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iODAiIHZpZXdCb3g9IjAgMCA4MCA4MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjgwIiBoZWlnaHQ9IjgwIiByeD0iNDAiIGZpbGw9InVybCgjZ3JhZGllbnQpIi8+CjxkZWZzPgo8bGluZWFyR3JhZGllbnQgaWQ9ImdyYWRpZW50IiB4MT0iMCIgeTE9IjAiIHgyPSIxIiB5Mj0iMSI+CjxzdG9wIG9mZnNldD0iMCUiIHN0b3AtY29sb3I9IiNlM2VkZmEiLz4KPHN0b3Agb2Zmc2V0PSIxMDAlIiBzdG9wLWNvbG9yPSIjZGJlYWZlIi8+CjwvbGluZWFyR3JhZGllbnQ+CjwvZGVmcz4KPHN2ZyB4PSIyMCIgeT0iMTUiIHdpZHRoPSI0MCIgaGVpZ2h0PSI0MCIgdmlld0JveD0iMCAwIDI0IDI0IiBmaWxsPSIjM2I4MmY2Ij4KPHBhdGggZD0iTTEyIDJDNi40OCAyIDIgNi40OCAyIDEyczQuNDggMTAgMTAgMTAgMTAtNC40OCAxMC0xMFMxNy41MiAyIDEyIDJ6bTAgM2MyLjY3IDAgNC44MyAyLjE2IDQuODMgNC44M1MxNC42NyAxNC42NiAxMiAxNC42NiA3LjE3IDEyLjUgNy4xNyA5LjgzIDkuMzMgNS4xNyAxMiA1LjE3em0wIDEyYzIuNSAwIDQuNzEtMS4yOCA2LTQuMjUtMS4yOS0yLjkyLTMuNS00LjI1LTYtNC4yNXMtNC43MSAxLjMzLTYgNC4yNWMxLjI5IDIuOTcgMy41IDQuMjUgNiA0LjI1eiIvPgo8L3N2Zz4KPC9zdmc+';
                col.innerHTML += `
                    <div class="student-item">
                        <img src="${photoSrc}" class="student-photo" alt="${stu.name}" title="點擊查看成績" onclick="goToStudentZone('${stu.id}')">
                        <div class="student-name">${stu.name}</div>
                    </div>
                `;
            });
            row.appendChild(col);
        });
    }
    
    // 生成班級篩選按鈕
    function renderClassFilter() {
        const filterContainer = document.getElementById('classFilter');
        studentsData.forEach(cls => {
            const button = document.createElement('button');
            button.className = 'btn btn-outline-primary btn-sm';
            button.setAttribute('data-class', cls.class);
            button.innerHTML = `<i class="fas fa-graduation-cap me-1"></i>${cls.class}`;
            button.onclick = function() {
                // 更新按鈕狀態
                filterContainer.querySelectorAll('button').forEach(btn => btn.classList.remove('active'));
                this.classList.add('active');
                
                // 重新渲染學生名單
                renderStudentList(cls.class);
            };
            filterContainer.appendChild(button);
        });
    }

    // 初始化頁面
    loadStudentPhotos();
    renderClassFilter();
    renderStudentList();
    
    // 綁定全部班級按鈕
    document.querySelector('[data-class="all"]').onclick = function() {
        document.getElementById('classFilter').querySelectorAll('button').forEach(btn => btn.classList.remove('active'));
        this.classList.add('active');
        renderStudentList('all');
    };
    
    // 監聽 localStorage 變化，即時更新相片
    window.addEventListener('storage', function(e) {
        if (e.key === 'studentPhotos') {
            loadStudentPhotos();
            renderStudentList();
        }
    });
    
    // 定期檢查相片更新（每2秒檢查一次）
    setInterval(function() {
        const currentPhotos = localStorage.getItem('studentPhotos');
        if (currentPhotos !== window.lastPhotosCheck) {
            window.lastPhotosCheck = currentPhotos;
            loadStudentPhotos();
            renderStudentList();
            console.log('學生名單相片已更新');
        }
    }, 2000);
    
    // 頁面獲得焦點時重新載入相片
    window.addEventListener('focus', function() {
        loadStudentPhotos();
        renderStudentList();
        console.log('頁面獲得焦點，重新載入相片');
    });
    
    // 頁面可見性變化時重新載入相片
    document.addEventListener('visibilitychange', function() {
        if (!document.hidden) {
            loadStudentPhotos();
            renderStudentList();
            console.log('頁面變為可見，重新載入相片');
        }
    });

    // 跳轉到個人專區
    function goToStudentZone(id) {
        window.location.href = `student-zone.html?id=${id}`;
    }
    
    // 手機優化 - 添加觸控反饋
    document.addEventListener('DOMContentLoaded', function() {
        // 為學生照片添加觸控反饋
        const studentPhotos = document.querySelectorAll('.student-photo');
        studentPhotos.forEach(photo => {
            photo.addEventListener('touchstart', function() {
                this.style.transform = 'scale(0.95)';
            });
            
            photo.addEventListener('touchend', function() {
                this.style.transform = 'scale(1)';
            });
        });
    });
    </script>
<script src="js/firebase-config.js"></script>
<script type="module">
  import { ensureAuth, db, storage } from './js/firebase.js';
  import { collection, getDocs } from 'https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js';
  import { ref, getDownloadURL } from 'https://www.gstatic.com/firebasejs/10.12.5/firebase-storage.js';

  async function tryStorageByName(name) {
    const candidates = [
      `${name}.jpg`, `${name}.jpeg`, `${name}.png`, `${name}.webp`,
      `students/${name}.jpg`, `students/${name}.jpeg`, `students/${name}.png`, `students/${name}.webp`
    ];
    for (const p of candidates) {
      try {
        const r = ref(storage, p);
        const url = await getDownloadURL(r);
        return url;
      } catch {}
    }
    return '';
  }

  async function hydratePhotosFromCloud() {
    try {
      await ensureAuth();
      const snap = await getDocs(collection(db, 'students'));
      const nameToPhoto = {};
      snap.forEach(d => {
        const s = d.data() || {};
        if (s.name) nameToPhoto[s.name] = s.photoUrl || '';
      });
      // 將雲端 photoUrl 或本地/Storage 回退寫回現有資料並重新渲染
      if (window.studentsData && Array.isArray(window.studentsData)) {
        for (const cls of window.studentsData) {
          for (const stu of (cls.students || [])) {
            const name = stu.name || '';
            // 1) Firestore photoUrl
            let url = nameToPhoto[name] || '';
            // 2) 若沒有，嘗試到 Storage 依常見副檔名與 students/ 前綴尋找
            if (!url && name) {
              url = await tryStorageByName(name);
            }
            // 3) 若仍沒有，用本地 PIC 回退
            if (!url) url = `PIC/${encodeURIComponent(name)}.jpg`;
            stu.photo = url;
          }
        }
        if (typeof window.renderStudentList === 'function') {
          window.renderStudentList('all');
        }
      }
    } catch (e) {
      // 讀雲端失敗不阻塞，本地仍可顯示
      console.warn('讀取雲端學生相片失敗：', e.message);
    }
  }

  hydratePhotosFromCloud();
</script>
</body>
</html> 