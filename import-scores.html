<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>匯入學生成績到 Firebase</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body class="bg-light">
  <div class="container py-4">
    <h2 class="mb-3 fw-bold" style="color:#2339d6;letter-spacing:1px;">匯入學生成績到 Firebase</h2>
    <p class="text-muted">上傳 JSON（欄位：name, front, jack, ski, bike, date）。系統會：
      <br>1) 以姓名建立/更新 `students` 文件（班級預設為「未分班」）
      <br>2) 將四大項寫入 `students/{id}/scores/{date_type}`
    </p>

    <div class="card shadow-sm mb-3">
      <div class="card-body">
        <div class="row g-3 align-items-end">
          <div class="col-md-4">
            <label class="form-label">教師登入（可選，若規則限制寫入）</label>
            <input type="email" id="email" class="form-control" placeholder="teacher@example.com" />
          </div>
          <div class="col-md-3">
            <input type="password" id="password" class="form-control" placeholder="密碼" />
          </div>
          <div class="col-md-2">
            <button id="loginBtn" class="btn btn-outline-primary w-100"><i class="fas fa-sign-in-alt me-1"></i>登入</button>
          </div>
        </div>
      </div>
    </div>

    <div class="card shadow-sm">
      <div class="card-body">
        <div class="row g-3 align-items-end">
          <div class="col-md-6">
            <label class="form-label">選擇 JSON 檔</label>
            <input type="file" id="fileInput" class="form-control" accept="application/json" />
          </div>
          <div class="col-md-3">
            <button id="importBtn" class="btn btn-primary w-100"><i class="fas fa-cloud-upload-alt me-1"></i>開始匯入</button>
          </div>
          <div class="col-md-3 text-end">
            <a href="students-list.html" class="btn btn-secondary"><i class="fas fa-list me-1"></i>返回學生名單</a>
          </div>
        </div>
        <div id="status" class="mt-3 small text-muted"></div>
        <div id="log" class="mt-3" style="white-space: pre-wrap; font-family: ui-monospace, Menlo, monospace;"></div>
      </div>
    </div>
  </div>

  <script src="js/firebase-config.js"></script>
  <script type="module">
    import { ensureAuth, db, addStudentScore, signInWithEmailAndPassword } from './js/firebase.js';
    import { collection, query, where, getDocs, addDoc, setDoc, doc, serverTimestamp } from 'https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js';
    import { getAuth } from 'https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js';

    const auth = getAuth();

    const statusEl = document.getElementById('status');
    const logEl = document.getElementById('log');
    function log(msg) { logEl.textContent += msg + '\n'; }
    function setStatus(msg) { statusEl.textContent = msg; }

    async function loginIfNeeded() {
      const email = (document.getElementById('email').value || '').trim();
      const password = (document.getElementById('password').value || '').trim();
      if (email && password) {
        await signInWithEmailAndPassword(auth, email, password);
      } else {
        await ensureAuth(); // 匿名登入
      }
    }

    async function getOrCreateStudentByName(name) {
      const colRef = collection(db, 'students');
      const q = query(colRef, where('name', '==', name));
      const snap = await getDocs(q);
      if (!snap.empty) {
        const d = snap.docs[0];
        return d.id;
      }
      const newDoc = await addDoc(colRef, { name, class: '未分班', createdAt: serverTimestamp() });
      return newDoc.id;
    }

    async function importFromJson(json) {
      const scores = Array.isArray(json?.scores) ? json.scores : [];
      let processed = 0;
      for (const row of scores) {
        const name = (row.name || '').trim();
        const date = row.date;
        if (!name || !date) { log(`略過：缺少 name 或 date -> ${JSON.stringify(row)}`); continue; }
        const studentId = await getOrCreateStudentByName(name);
        if (Number.isFinite(Number(row.front))) await addStudentScore(studentId, 'frontJump', Number(row.front), date);
        if (Number.isFinite(Number(row.jack))) await addStudentScore(studentId, 'jumpingJack', Number(row.jack), date);
        if (Number.isFinite(Number(row.ski))) await addStudentScore(studentId, 'skiJump', Number(row.ski), date);
        if (Number.isFinite(Number(row.bike))) await addStudentScore(studentId, 'bicycleStep', Number(row.bike), date);
        processed++;
      }
      return processed;
    }

    document.getElementById('loginBtn').onclick = async () => {
      try {
        await loginIfNeeded();
        setStatus('登入成功');
      } catch (e) {
        setStatus('登入失敗：' + e.message);
      }
    };

    document.getElementById('importBtn').onclick = async () => {
      const file = document.getElementById('fileInput').files[0];
      if (!file) { setStatus('請先選擇 JSON 檔'); return; }
      setStatus('處理中...'); logEl.textContent = '';
      try {
        await loginIfNeeded();
        const text = await file.text();
        const json = JSON.parse(text);
        const count = await importFromJson(json);
        setStatus(`完成，已處理 ${count} 列成績。`);
      } catch (e) {
        console.error(e);
        setStatus('匯入失敗：' + e.message);
      }
    };
  </script>
</body>
</html>


