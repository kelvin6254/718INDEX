<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>學生相片批量匯入 - 基督教中國佈道會聖道學校</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body { background: #f4f8fb; font-family: 'Microsoft JhengHei', Arial, sans-serif; }
        .header { background: linear-gradient(135deg, #2563eb 0%, #1e3a8a 100%); color: white; padding: 2rem 0; text-align: center; }
        .upload-area { border: 3px dashed #2563eb; border-radius: 15px; padding: 3rem; text-align: center; background: #f8fafc; transition: all 0.3s ease; cursor: pointer; }
        .upload-area:hover { border-color: #1e3a8a; background: #e3edfa; }
        .student-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 1rem; margin-top: 2rem; }
        .student-card { background: white; border-radius: 10px; padding: 1rem; box-shadow: 0 2px 8px rgba(0,0,0,0.1); text-align: center; }
        .student-photo { width: 80px; height: 80px; border-radius: 50%; object-fit: cover; border: 3px solid #3b82f6; margin-bottom: 0.5rem; }
        .student-photo.placeholder { background: linear-gradient(135deg, #e3edfa 0%, #dbeafe 100%); display: flex; align-items: center; justify-content: center; color: #3b82f6; font-size: 2rem; }
        .student-name { font-weight: 600; color: #1e3a8a; margin-bottom: 0.25rem; }
        .student-class { font-size: 0.9rem; color: #64748b; }
        .action-buttons { display: flex; gap: 1rem; justify-content: center; margin: 2rem 0; }
        .btn-custom { padding: 0.75rem 2rem; border-radius: 8px; font-weight: 600; }
        .btn-info { color: white; background: #0ea5e9; border: none; }
        .btn-info:hover { background: #2563eb; color: white; }
        .file-input { display: none; }
    </style>
</head>
<body>
    <div class="header">
        <div class="container">
            <h1><i class="fas fa-users me-3"></i>學生相片批量匯入</h1>
        </div>
    </div>
    <div class="container py-4">
        <div class="upload-area" id="uploadArea">
            <h4>拖拽相片檔案到此處或點擊選擇檔案</h4>
            <input type="file" id="fileInput" class="file-input" multiple accept="image/*">
            <button class="btn btn-primary btn-custom" onclick="document.getElementById('fileInput').click()">
                <i class="fas fa-folder-open me-2"></i>選擇檔案
            </button>
        </div>
        <div class="action-buttons">
            <button class="btn btn-primary btn-custom" onclick="autoMatchPhotos()">
                <i class="fas fa-magic me-2"></i>自動匹配相片
            </button>
            <button class="btn btn-info btn-custom" onclick="forceSync()">
                <i class="fas fa-sync me-2"></i>強制同步
            </button>
        </div>
        <div class="student-grid" id="studentGrid"></div>
    </div>
    <script>
        // 直接複製 students-list.html 的 studentsData 與自動補 id
        const studentsData = [
            { class: '高中三', students: [
                { name: '羅諭琦', id: '', photo: '' },
                { name: '盧諄霖', id: '', photo: '' },
                { name: '洪俊豪', id: '', photo: '' },
                { name: '歐陽浩田', id: '', photo: '' },
                { name: '黎耀駿', id: '', photo: '' },
                { name: '伍康舜', id: '', photo: '' },
                { name: '施汪濤', id: '', photo: '' },
                { name: '郭鈞焯', id: '', photo: '' },
                { name: 'Ali', id: '', photo: '' },
                { name: '丁嘉瑩', id: '', photo: '' },
                { name: '白樂天', id: '', photo: '' },
                { name: '朱耀鋒', id: '', photo: '' },
                { name: 'Inderveer', id: '', photo: '' }
            ] },
            // ... 其餘班級 ...
        ];
        (function assignStudentIds() {
            let idCounter = 1;
            studentsData.forEach(cls => {
                cls.students.forEach(stu => {
                    stu.id = idCounter.toString().padStart(3, '0');
                    idCounter++;
                });
            });
        })();

        let uploadedFiles = [];
        document.addEventListener('DOMContentLoaded', function() {
            renderStudentGrid();
            setupEventListeners();
            loadExistingPhotos();
        });
        function setupEventListeners() {
            const uploadArea = document.getElementById('uploadArea');
            const fileInput = document.getElementById('fileInput');
            uploadArea.addEventListener('dragover', e => { e.preventDefault(); uploadArea.classList.add('dragover'); });
            uploadArea.addEventListener('dragleave', e => { e.preventDefault(); uploadArea.classList.remove('dragover'); });
            uploadArea.addEventListener('drop', e => { e.preventDefault(); uploadArea.classList.remove('dragover'); handleFileUpload(Array.from(e.dataTransfer.files)); });
            fileInput.addEventListener('change', e => { handleFileUpload(Array.from(e.target.files)); });
        }
        function handleFileUpload(files) {
            const imageFiles = files.filter(file => file.type.startsWith('image/'));
            if (imageFiles.length === 0) { alert('請選擇圖片檔案'); return; }
            // 自動匹配
            let matched = 0;
            imageFiles.forEach(file => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    // 根據檔名自動匹配學生
                    const fileName = file.name.toLowerCase();
                    let found = false;
                    studentsData.forEach(cls => {
                        cls.students.forEach(stu => {
                            if (!stu.photo) {
                                const stuName = stu.name.toLowerCase();
                                if (fileName.includes(stuName) || fileName.includes(stuName.replace(/\s+/g, ''))) {
                                    stu.photo = e.target.result;
                                    matched++;
                                    found = true;
                                }
                            }
                        });
                    });
                };
                reader.readAsDataURL(file);
            });
            setTimeout(() => {
                saveStudentPhotos();
                renderStudentGrid();
                alert(`已自動匹配 ${matched} 張相片。`);
            }, 500);
        }
        function renderStudentGrid() {
            const grid = document.getElementById('studentGrid');
            let html = '';
            studentsData.forEach(cls => {
                cls.students.forEach(student => {
                    const hasPhoto = student.photo && student.photo !== '';
                    html += `
                        <div class="student-card" data-student-id="${student.id}">
                            <div class="student-photo ${hasPhoto ? '' : 'placeholder'}" onclick="uploadPhotoForStudent('${student.id}')">
                                ${hasPhoto ? `<img src="${student.photo}" alt="${student.name}" class="student-photo">` : `<i class="fas fa-user"></i>`}
                            </div>
                            <div class="student-name">${student.name}</div>
                            <div class="student-class">${cls.class}</div>
                        </div>
                    `;
                });
            });
            grid.innerHTML = html;
        }
        function uploadPhotoForStudent(studentId) {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*';
            input.onchange = function(e) {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        const student = findStudentById(studentId);
                        if (student) {
                            student.photo = e.target.result;
                            saveStudentPhotos();
                            renderStudentGrid();
                        }
                    };
                    reader.readAsDataURL(file);
                }
            };
            input.click();
        }
        function findStudentById(id) {
            for (const cls of studentsData) {
                for (const student of cls.students) {
                    if (student.id === id) return student;
                }
            }
            return null;
        }
        function autoMatchPhotos() {
            if (uploadedFiles.length === 0) { alert('請先上傳相片檔案'); return; }
            let matched = 0;
            let totalToMatch = 0;
            studentsData.forEach(cls => { cls.students.forEach(student => { if (!student.photo || student.photo === '') totalToMatch++; }); });
            if (totalToMatch === 0) { alert('所有學生都已有相片！'); return; }
            studentsData.forEach(cls => {
                cls.students.forEach(student => {
                    if (!student.photo || student.photo === '') {
                        const matchedFile = uploadedFiles.find(file => {
                            const fileName = file.name.toLowerCase();
                            const studentName = student.name.toLowerCase();
                            return fileName.includes(studentName) || fileName.includes(studentName.replace(/\s+/g, ''));
                        });
                        if (matchedFile) {
                            const reader = new FileReader();
                            reader.onload = function(e) {
                                student.photo = e.target.result;
                                matched++;
                                saveStudentPhotos();
                                renderStudentGrid();
                                if (matched === totalToMatch) {
                                    alert(`自動匹配完成！成功匹配 ${matched} 張相片`);
                                }
                            };
                            reader.readAsDataURL(matchedFile);
                        }
                    }
                });
            });
        }
        function saveStudentPhotos() {
            localStorage.setItem('studentPhotos', JSON.stringify(studentsData));
        }
        function loadExistingPhotos() {
            const saved = localStorage.getItem('studentPhotos');
            if (saved) {
                const savedData = JSON.parse(saved);
                // 用 id 對應合併
                const photoMap = {};
                savedData.forEach(cls => {
                    cls.students.forEach(stu => {
                        if (stu.id && stu.photo) {
                            photoMap[stu.id] = stu.photo;
                        }
                    });
                });
                studentsData.forEach(cls => {
                    cls.students.forEach(stu => {
                        if (photoMap[stu.id]) {
                            stu.photo = photoMap[stu.id];
                        }
                    });
                });
            }
        }
        function forceSync() {
            saveStudentPhotos();
            renderStudentGrid();
            alert('已強制同步相片資料！\n\n請在其他頁面按 F5 重新整理或切換標籤頁來查看更新。');
        }
    </script>
</body>
</html>