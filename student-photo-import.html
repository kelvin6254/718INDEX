<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å­¸ç”Ÿç›¸ç‰‡æ‰¹é‡åŒ¯å…¥ - åŸºç£æ•™ä¸­åœ‹ä½ˆé“æœƒè–é“å­¸æ ¡</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body { background: #f4f8fb; font-family: 'Microsoft JhengHei', Arial, sans-serif; }
        .header { background: linear-gradient(135deg, #2563eb 0%, #1e3a8a 100%); color: white; padding: 2rem 0; text-align: center; }
        .upload-area { border: 3px dashed #2563eb; border-radius: 15px; padding: 3rem; text-align: center; background: #f8fafc; transition: all 0.3s ease; cursor: pointer; }
        .upload-area:hover { border-color: #1e3a8a; background: #e3edfa; }
        .upload-area.dragover { border-color: #059669; background: #d1fae5; transform: scale(1.02); }
        .student-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 1rem; margin-top: 2rem; }
        .student-card { background: white; border-radius: 10px; padding: 1rem; box-shadow: 0 2px 8px rgba(0,0,0,0.1); text-align: center; }
        .student-photo { width: 80px; height: 80px; border-radius: 50%; object-fit: cover; border: 3px solid #3b82f6; margin-bottom: 0.5rem; }
        .student-photo.placeholder { background: linear-gradient(135deg, #e3edfa 0%, #dbeafe 100%); display: flex; align-items: center; justify-content: center; color: #3b82f6; font-size: 2rem; }
        .student-name { font-weight: 600; color: #1e3a8a; margin-bottom: 0.25rem; }
        .student-class { font-size: 0.9rem; color: #64748b; }
        .action-buttons { display: flex; gap: 1rem; justify-content: center; margin: 2rem 0; }
        .btn-custom { padding: 0.75rem 2rem; border-radius: 8px; font-weight: 600; }
        .btn-info { color: white; background: #0ea5e9; border: none; }
        .btn-info:hover { background: #2563eb; color: white; }
        .file-input { display: none; }
    </style>
</head>
<body>
    <div class="header">
        <div class="container">
            <h1><i class="fas fa-users me-3"></i>å­¸ç”Ÿç›¸ç‰‡æ‰¹é‡åŒ¯å…¥</h1>
        </div>
    </div>
    <div class="container py-4">
        <div class="upload-area" id="uploadArea">
            <h4>æ‹–æ‹½ç›¸ç‰‡æª”æ¡ˆåˆ°æ­¤è™•æˆ–é»æ“Šé¸æ“‡æª”æ¡ˆ</h4>
            <input type="file" id="fileInput" class="file-input" multiple accept="image/*">
            <button class="btn btn-primary btn-custom" onclick="document.getElementById('fileInput').click()">
                <i class="fas fa-folder-open me-2"></i>é¸æ“‡æª”æ¡ˆ
            </button>
            <div class="mt-3">
                <small class="text-muted">
                    <strong>æª”æ¡ˆå‘½åå»ºè­°ï¼š</strong><br>
                    â€¢ è¶™é–æ˜•.jpg<br>
                    â€¢ IMG_001_è¶™é–æ˜•.jpg<br>
                    â€¢ photo-ç¾…è«­ç¦-2024.jpg<br>
                    â€¢ å­¸ç”Ÿç…§ç‰‡_é»ƒæ¨‚æº.png<br>
                    â€¢ Ali.jpg (è‹±æ–‡å§“å)<br>
                    â€¢ IMG_Ali_001.jpg (è‹±æ–‡å§“å)
                </small>
            </div>
        </div>
        <div class="action-buttons">
            <button class="btn btn-primary btn-custom" onclick="autoMatchPhotos()">
                <i class="fas fa-magic me-2"></i>è‡ªå‹•åŒ¹é…ç›¸ç‰‡
            </button>
            <button class="btn btn-info btn-custom" onclick="forceSync()">
                <i class="fas fa-sync me-2"></i>å¼·åˆ¶åŒæ­¥
            </button>
            <button class="btn btn-warning btn-custom" onclick="clearAllPhotos()">
                <i class="fas fa-trash me-2"></i>æ¸…é™¤æ‰€æœ‰ç›¸ç‰‡
            </button>
            <button class="btn btn-secondary btn-custom" onclick="checkDuplicatePhotos()">
                <i class="fas fa-search me-2"></i>æª¢æŸ¥é‡è¤‡ç›¸ç‰‡
            </button>
            <button class="btn btn-success btn-custom" onclick="manualSave()">
                <i class="fas fa-save me-2"></i>æ‰‹å‹•å„²å­˜
            </button>
            <button class="btn btn-outline-info btn-custom" onclick="testFileNameMatching()">
                <i class="fas fa-vial me-2"></i>æ¸¬è©¦æª”æ¡ˆåç¨±åŒ¹é…
            </button>
            <button class="btn btn-outline-warning btn-custom" onclick="checkAvailableStudents()">
                <i class="fas fa-users me-2"></i>æª¢æŸ¥å¯é…å°å­¸ç”Ÿ
            </button>
            <button class="btn btn-outline-danger btn-custom" onclick="forceRematch()">
                <i class="fas fa-redo me-2"></i>å¼·åˆ¶é‡æ–°åŒ¹é…
            </button>
        </div>
        <div class="text-center mb-3">
            <div class="badge bg-success fs-6" id="photoStats">
                <i class="fas fa-camera me-2"></i>è¼‰å…¥ä¸­...
            </div>
        </div>
        <div class="student-grid" id="studentGrid"></div>
    </div>
    <script>
        // å®Œæ•´çš„å­¸ç”Ÿè³‡æ–™ï¼ŒåŒ…å«å…¨æ ¡å­¸ç”Ÿ
        const studentsData = [
            {
                class: 'é«˜ä¸­ä¸‰',
                students: [
                    { name: 'ç¾…è«­ç¦', id: '', photo: '' },
                    { name: 'ç›§è«„éœ–', id: '', photo: '' },
                    { name: 'æ´ªä¿Šè±ª', id: '', photo: '' },
                    { name: 'æ­é™½æµ©ç”°', id: '', photo: '' },
                    { name: 'é»è€€é§¿', id: '', photo: '' },
                    { name: 'ä¼åº·èˆœ', id: '', photo: '' },
                    { name: 'æ–½æ±ªæ¿¤', id: '', photo: '' },
                    { name: 'éƒ­éˆç„¯', id: '', photo: '' },
                    { name: 'Ali', id: '', photo: '' },
                    { name: 'ä¸å˜‰ç‘©', id: '', photo: '' },
                    { name: 'ç™½æ¨‚å¤©', id: '', photo: '' },
                    { name: 'æœ±è€€é‹’', id: '', photo: '' },
                    { name: 'Inderveer', id: '', photo: '' }
                ]
            },
            {
                class: 'é«˜ä¸­äºŒ',
                students: [
                    { name: 'é»ƒæ¨‚æº', id: '', photo: '' },
                    { name: 'å³å‡±å©·', id: '', photo: '' },
                    { name: 'Sudais', id: '', photo: '' },
                    { name: 'æ­é™½èŠ·ç©', id: '', photo: '' },
                    { name: 'ä¼æµ©éœ–', id: '', photo: '' },
                    { name: 'æä¿¡æ¥ ', id: '', photo: '' },
                    { name: 'é™³æˆé‘«', id: '', photo: '' },
                    { name: 'å¼µå–„å©·', id: '', photo: '' },
                    { name: 'æ¢æ¯…éŸœ', id: '', photo: '' },
                    { name: 'æ—å»ºå»·', id: '', photo: '' },
                    { name: 'Alvin', id: '', photo: '' },
                    { name: 'å³æ¼¢æ£‹', id: '', photo: '' },
                    { name: 'é»ƒä»²æ’', id: '', photo: '' }
                ]
            },
            {
                class: 'é«˜ä¸­ä¸€',
                students: [
                    { name: 'ä½™æ˜äº®', id: '', photo: '' },
                    { name: 'è‘‰æµ·æ¾„', id: '', photo: '' },
                    { name: 'æå¿ƒæ‚…', id: '', photo: '' },
                    { name: 'é»ƒå¿ƒæ€¡', id: '', photo: '' },
                    { name: 'æ¢…æ˜•æ™´', id: '', photo: '' },
                    { name: 'æœ±ç©å¿ƒ', id: '', photo: '' },
                    { name: 'è˜‡å—ç‡Š', id: '', photo: '' },
                    { name: 'ç‹å¼˜å¸Œ', id: '', photo: '' },
                    { name: 'é„­å‡±æ–‡', id: '', photo: '' },
                    { name: 'é™³æ˜±å‡', id: '', photo: '' },
                    { name: 'å”æ¢“çŠ', id: '', photo: '' },
                    { name: 'å·«æ›‰å³°', id: '', photo: '' },
                    { name: 'æ—æ€æ’', id: '', photo: '' }
                ]
            },
            {
                class: 'åˆä¸­å››',
                students: [
                    { name: 'å‘¨æ™‰ç›', id: '', photo: '' },
                    { name: 'é™³æ¾”äº®', id: '', photo: '' },
                    { name: 'è‘‰èŠ·æ±', id: '', photo: '' },
                    { name: 'æ—å®¶æœ—', id: '', photo: '' },
                    { name: 'é—œç¥ˆç« ', id: '', photo: '' },
                    { name: 'æ´ªå®‡è»’', id: '', photo: '' },
                    { name: 'é¾æ”¿å¸Œ', id: '', photo: '' },
                    { name: 'è”¡èŠ·å®œ', id: '', photo: '' }
                ]
            },
            {
                class: 'åˆä¸­ä¸‰',
                students: [
                    { name: 'éº¥æ¢“æ·³', id: '', photo: '' },
                    { name: 'é„§æ—¨åªƒ', id: '', photo: '' },
                    { name: 'å³è«¾æš‰', id: '', photo: '' },
                    { name: 'è¨±å®¶æ™', id: '', photo: '' },
                    { name: 'è¬æ˜“ç”·', id: '', photo: '' },
                    { name: 'æ—è©©å½¤', id: '', photo: '' },
                    { name: 'è¬å˜‰è¬™', id: '', photo: '' },
                    { name: 'æ¢ç€æº', id: '', photo: '' },
                    { name: 'å¼µå‡±ç¥º', id: '', photo: '' }
                ]
            },
            {
                class: 'åˆä¸­äºŒ',
                students: [
                    { name: 'è”¡æ¿ å', id: '', photo: '' },
                    { name: 'è¨±æµšéŠ˜', id: '', photo: '' },
                    { name: 'è³´æµšæ£‹', id: '', photo: '' },
                    { name: 'æ¥Šè‡»ä¸€', id: '', photo: '' },
                    { name: 'é™³é€²æµ©', id: '', photo: '' },
                    { name: 'é»ƒå´‡åº·', id: '', photo: '' },
                    { name: 'éŸ“ä¿Šå¸Œ', id: '', photo: '' },
                    { name: 'æ¢å¿ƒæ‚ ', id: '', photo: '' },
                    { name: 'è¬æ¢“å¥', id: '', photo: '' }
                ]
            },
            {
                class: 'åˆä¸­ä¸€',
                students: [
                    { name: 'è¨±é€¸å³°', id: '', photo: '' },
                    { name: 'æ—å®æ™‰', id: '', photo: '' },
                    { name: 'éŒ¢å¯¶å­˜', id: '', photo: '' },
                    { name: 'é›²èªå«£', id: '', photo: '' },
                    { name: 'ææ¾¤æ°‘', id: '', photo: '' },
                    { name: 'é™³ç©æœ—', id: '', photo: '' },
                    { name: 'é»ƒé€¸æœ—', id: '', photo: '' },
                    { name: 'å¼µå€©ç‘œ', id: '', photo: '' },
                    { name: 'ç›§ä½©å„€', id: '', photo: '' },
                    { name: 'è¢åŸ¹ç‹', id: '', photo: '' }
                ]
            },
            { class: 'é«˜å°äº”', students: [
                { name: 'é«˜çƒ¯ç‘œ', id: '', photo: '' },
                { name: 'é™³å‚²é›²', id: '', photo: '' },
                { name: 'é»æº¢é‰¦', id: '', photo: '' },
                { name: 'æ—è©©è—', id: '', photo: '' },
                { name: 'å‘¨å¥•æœ—', id: '', photo: '' },
                { name: 'æ—éŠ³æ·»', id: '', photo: '' },
                { name: 'ä¸ç¿°é', id: '', photo: '' },
                { name: 'å³å“é—', id: '', photo: '' },
                { name: 'æ±ªä¿Šç', id: '', photo: '' },
                { name: 'æ–‡æ©ç¥ˆ', id: '', photo: '' },
                { name: 'é™³æ—¨è»’', id: '', photo: '' },
                { name: 'å¼µå˜‰å…’', id: '', photo: '' }
            ] },
            { class: 'é«˜å°å››', students: [
                { name: 'é„§ç¥ˆä½‘', id: '', photo: '' },
                { name: 'è³´ç„¯ç†¹', id: '', photo: '' },
                { name: 'é»ƒå­è»’', id: '', photo: '' },
                { name: 'æ¢èŒœç¨‹', id: '', photo: '' },
                { name: 'é»ƒæ³³éˆº', id: '', photo: '' },
                { name: 'æ²ˆæŸç†¹', id: '', photo: '' },
                { name: 'å³æ¢“åŸ', id: '', photo: '' }
            ] },
            { class: 'é«˜å°ä¸‰', students: [
                { name: 'æ–¹å›ç¿', id: '', photo: '' },
                { name: 'éº¥æµ©æ•', id: '', photo: '' },
                { name: 'æé›¨è•Š', id: '', photo: '' },
                { name: 'ä½™è’‚å³°', id: '', photo: '' },
                { name: 'æ¥Šæ´›è¬™', id: '', photo: '' },
                { name: 'æ—å­ç«£', id: '', photo: '' },
                { name: 'é¦®æ¨‚å®', id: '', photo: '' },
                { name: 'è¬éŸ¶è¬™', id: '', photo: '' }
            ] },
            { class: 'é«˜å°äºŒ', students: [
                { name: 'æ¢æ™‰éŠ˜', id: '', photo: '' },
                { name: 'å¾å­æ·³', id: '', photo: '' },
                { name: 'ä¼ç–ç³', id: '', photo: '' },
                { name: 'æ›¾æ¥­æ·³', id: '', photo: '' },
                { name: 'æ–¹å­ä»', id: '', photo: '' },
                { name: 'é™³è¡å¡', id: '', photo: '' },
                { name: 'éŸ“é®è°', id: '', photo: '' },
                { name: 'é¦®é®æ³“', id: '', photo: '' },
                { name: 'å¼µé€¸æœ—', id: '', photo: '' }
            ] },
            { class: 'é«˜å°ä¸€', students: [
                { name: 'æ—ç†™ç¨‹', id: '', photo: '' },
                { name: 'æä¿Šç†¹', id: '', photo: '' },
                { name: 'æ½˜å½¥æ—­', id: '', photo: '' },
                { name: 'åŠ‰å­é¾', id: '', photo: '' },
                { name: 'å€ªç', id: '', photo: '' },
                { name: 'é™³æ³³éœ–', id: '', photo: '' },
                { name: 'æ½˜å½¥æ±', id: '', photo: '' }
            ] },
            { class: 'åˆå°å››', students: [
                { name: 'è”¡æ¾¤éŠ˜', id: '', photo: '' },
                { name: 'é¾å˜‰è«¾', id: '', photo: '' },
                { name: 'è­šè© æ®·', id: '', photo: '' },
                { name: 'é„ºèŠ·ç‘©', id: '', photo: '' },
                { name: 'æå“éœ–', id: '', photo: '' },
                { name: 'è•­æ´›å¸Œ', id: '', photo: '' },
                { name: 'ææŸè¨€', id: '', photo: '' },
                { name: 'è¶™é–æ˜•', id: '', photo: '' },
                { name: 'æ­çŸ¥ç©', id: '', photo: '' },
                { name: 'åŠ‰æ˜Ÿåº§', id: '', photo: '' },
                { name: 'é»ƒæ¸å©·', id: '', photo: '' }
            ] },
            { class: 'åˆå°ä¸‰', students: [
                { name: 'æ—æ¾¤æ˜Ÿ', id: '', photo: '' },
                { name: 'æé«˜ç•¥', id: '', photo: '' },
                { name: 'ç¾…å¹´æ´²', id: '', photo: '' },
                { name: 'æ–½å®‡è»’', id: '', photo: '' },
                { name: 'é™³å­¸ç¦®', id: '', photo: '' },
                { name: 'æ›¾æº¢çŸ¥', id: '', photo: '' },
                { name: 'é™³å®¶æº±', id: '', photo: '' },
                { name: 'è”¡ç€šæ¯…', id: '', photo: '' },
                { name: 'æ¥Šå‡±ç³', id: '', photo: '' },
                { name: 'é¾æ­£ç½¡', id: '', photo: '' }
            ] },
            { class: 'åˆå°äºŒ', students: [
                { name: 'å¼µæ¿¬éœ–', id: '', photo: '' },
                { name: 'æ¢èª è»’', id: '', photo: '' },
                { name: 'å”é§æ»”', id: '', photo: '' },
                { name: 'OLIVIA (NCS)', id: '', photo: '' },
                { name: 'WALEED (NCS)', id: '', photo: '' },
                { name: 'æ¢æ¢“å›', id: '', photo: '' },
                { name: 'è¨±æ˜ç„¶', id: '', photo: '' },
                { name: 'AROUSE (NCS)', id: '', photo: '' },
                { name: 'å¼µçš“ç„¶', id: '', photo: '' },
                { name: 'é™³å¾·æ·»', id: '', photo: '' }
            ] },
            { class: 'åˆå°ä¸€', students: [
                { name: 'æ—æ¢“å®‡', id: '', photo: '' },
                { name: 'é»ƒæ¢“éˆº', id: '', photo: '' },
                { name: 'é»ƒæ™‰è±«', id: '', photo: '' },
                { name: 'é„”æµ©éœ–', id: '', photo: '' },
                { name: 'æ—æŸè¨€', id: '', photo: '' },
                { name: 'åŠ‰ä½©è«­', id: '', photo: '' },
                { name: 'è¶™æŸç„¶', id: '', photo: '' },
                { name: 'åŠ‰æ˜Ÿå®™', id: '', photo: '' },
                { name: 'è‘‰å°šæ¨º', id: '', photo: '' },
                { name: 'è¬æµ©ç¸‰', id: '', photo: '' },
                { name: 'é¾æ‡‰ç¬™', id: '', photo: '' }
            ] }
        ];
        (function assignStudentIds() {
            let idCounter = 1;
            studentsData.forEach(cls => {
                cls.students.forEach(stu => {
                    stu.id = idCounter.toString().padStart(3, '0');
                    idCounter++;
                });
            });
        })();

        let uploadedFiles = [];
        document.addEventListener('DOMContentLoaded', function() {
            renderStudentGrid();
            setupEventListeners();
            loadExistingPhotos();
            
            // å®šæœŸè‡ªå‹•å„²å­˜ï¼ˆæ¯30ç§’ï¼‰
            setInterval(() => {
                saveStudentPhotos();
            }, 30000);
            
            // é é¢é›¢é–‹å‰è‡ªå‹•å„²å­˜
            window.addEventListener('beforeunload', () => {
                saveStudentPhotos();
            });
            
            // é é¢ç²å¾—ç„¦é»æ™‚é‡æ–°è¼‰å…¥è³‡æ–™
            window.addEventListener('focus', () => {
                loadExistingPhotos();
                renderStudentGrid();
            });
        });
        function setupEventListeners() {
            const uploadArea = document.getElementById('uploadArea');
            const fileInput = document.getElementById('fileInput');
            
            // æ‹–æ‹‰äº‹ä»¶è™•ç†
            uploadArea.addEventListener('dragover', e => { 
                e.preventDefault(); 
                e.stopPropagation();
                uploadArea.classList.add('dragover'); 
            });
            
            uploadArea.addEventListener('dragenter', e => {
                e.preventDefault();
                e.stopPropagation();
                uploadArea.classList.add('dragover');
            });
            
            uploadArea.addEventListener('dragleave', e => { 
                e.preventDefault(); 
                e.stopPropagation();
                // åªæœ‰ç•¶é›¢é–‹ä¸Šå‚³å€åŸŸæ™‚æ‰ç§»é™¤æ¨£å¼
                if (!uploadArea.contains(e.relatedTarget)) {
                    uploadArea.classList.remove('dragover'); 
                }
            });
            
            uploadArea.addEventListener('drop', e => { 
                e.preventDefault(); 
                e.stopPropagation();
                uploadArea.classList.remove('dragover'); 
                
                const files = Array.from(e.dataTransfer.files);
                console.log('æ‹–æ‹‰æª”æ¡ˆ:', files);
                
                // ç¢ºä¿æœ‰æª”æ¡ˆæ‰è™•ç†
                if (files.length > 0) {
                    handleFileUpload(files);
                }
            });
            
            // æª”æ¡ˆé¸æ“‡äº‹ä»¶
            fileInput.addEventListener('change', e => { 
                const files = Array.from(e.target.files);
                console.log('é¸æ“‡æª”æ¡ˆ:', files);
                
                // ç¢ºä¿æœ‰æª”æ¡ˆæ‰è™•ç†
                if (files.length > 0) {
                    handleFileUpload(files);
                }
                
                // æ¸…ç©º input å€¼ï¼Œå…è¨±é‡è¤‡é¸æ“‡ç›¸åŒæª”æ¡ˆ
                e.target.value = '';
            });
            
            // é»æ“Šä¸Šå‚³å€åŸŸè§¸ç™¼æª”æ¡ˆé¸æ“‡
            uploadArea.addEventListener('click', (e) => {
                // é¿å…èˆ‡æ‹–æ‹‰äº‹ä»¶è¡çª
                if (e.target === uploadArea || uploadArea.contains(e.target)) {
                    fileInput.click();
                }
            });
            
            // é˜²æ­¢æ•´å€‹é é¢çš„æ‹–æ‹‰äº‹ä»¶å¹²æ“¾
            document.addEventListener('dragover', e => e.preventDefault());
            document.addEventListener('drop', e => e.preventDefault());
        }
        
        function handleFileUpload(files) {
            console.log('é–‹å§‹è™•ç†æª”æ¡ˆ:', files);
            
            const imageFiles = files.filter(file => file.type.startsWith('image/'));
            if (imageFiles.length === 0) { 
                alert('è«‹é¸æ“‡åœ–ç‰‡æª”æ¡ˆï¼ˆæ”¯æ´ JPGã€PNGã€GIF ç­‰æ ¼å¼ï¼‰'); 
                return; 
            }
            
            console.log(`ä¸Šå‚³äº† ${imageFiles.length} å€‹åœ–ç‰‡æª”æ¡ˆ`);
            
            // ç§»é™¤èˆŠçš„è™•ç†æç¤º
            const oldProcessingDiv = document.getElementById('processingDiv');
            if (oldProcessingDiv) {
                oldProcessingDiv.remove();
            }
            
            // è‡ªå‹•åŒ¹é…
            let processedCount = 0;
            let matched = 0;
            let unmatchedFiles = [];
            let errors = [];
            
            // é¡¯ç¤ºè™•ç†ä¸­æç¤º
            const processingDiv = document.createElement('div');
            processingDiv.id = 'processingDiv';
            processingDiv.innerHTML = `
                <div class="alert alert-info text-center">
                    <i class="fas fa-spinner fa-spin me-2"></i>æ­£åœ¨è™•ç† ${imageFiles.length} å€‹æª”æ¡ˆ...
                </div>
                <div class="mt-2">
                    <small class="text-muted">æª”æ¡ˆåç¨±æ¸…ç†ç¯„ä¾‹ï¼š</small><br>
                    <small class="text-muted">IMG_001_è¶™é–æ˜•.jpg â†’ è¶™é–æ˜•</small><br>
                    <small class="text-muted">photo-ç¾…è«­ç¦-2024.jpg â†’ ç¾…è«­ç¦</small>
                </div>
            `;
            
            // å®‰å…¨åœ°æ’å…¥è™•ç†æç¤º - ä½¿ç”¨æ›´ç°¡å–®çš„æ–¹æ³•
            try {
                const container = document.querySelector('.container');
                if (container) {
                    // å…ˆç§»é™¤èˆŠçš„è™•ç†æç¤º
                    const oldProcessingDiv = document.getElementById('processingDiv');
                    if (oldProcessingDiv) {
                        oldProcessingDiv.remove();
                    }
                    
                    // ç›´æ¥æ·»åŠ åˆ°å®¹å™¨æœ«å°¾
                    container.appendChild(processingDiv);
                }
            } catch (error) {
                console.error('æ’å…¥è™•ç†æç¤ºæ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
                // å¦‚æœæ’å…¥å¤±æ•—ï¼Œè‡³å°‘é¡¯ç¤ºä¸€å€‹ç°¡å–®çš„æç¤º
                alert(`é–‹å§‹è™•ç† ${imageFiles.length} å€‹æª”æ¡ˆ...`);
            }
            
            imageFiles.forEach((file, index) => {
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    try {
                        // æ ¹æ“šæª”åè‡ªå‹•åŒ¹é…å­¸ç”Ÿ
                        const fileName = file.name.toLowerCase();
                        let bestMatch = null;
                        let bestMatchScore = 0;
                        
                        console.log(`è™•ç†æª”æ¡ˆ: ${fileName}`);
                        
                        // æ‰¾åˆ°æœ€ä½³åŒ¹é…çš„å­¸ç”Ÿ
                        studentsData.forEach(cls => {
                            cls.students.forEach(stu => {
                                if (!stu.photo) {
                                    const stuName = stu.name.toLowerCase();
                                    let matchScore = 0;
                                    let matchType = '';
                                    
                                    // æ¸…ç†æª”æ¡ˆåç¨±ï¼ˆç§»é™¤å‰¯æª”åå’Œå¸¸è¦‹å‰ç¶´ï¼‰
                                    const cleanFileName = fileName
                                        .replace(/\.(jpg|jpeg|png|gif|bmp|webp)$/i, '') // ç§»é™¤å‰¯æª”å
                                        .replace(/^(img_|dsc_|photo_|pic_|image_)/i, '') // ç§»é™¤å¸¸è¦‹å‰ç¶´
                                        .replace(/[_\-\s]+/g, '') // ç§»é™¤åº•ç·šã€é€£å­—è™Ÿã€ç©ºæ ¼
                                        .replace(/[0-9]+/g, ''); // ç§»é™¤æ•¸å­—
                                    
                                    // æ¸…ç†å­¸ç”Ÿå§“å
                                    const cleanStuName = stuName
                                        .replace(/\s+/g, '') // ç§»é™¤ç©ºæ ¼
                                        .replace(/[^\u4e00-\u9fa5a-zA-Z]/g, ''); // åªä¿ç•™ä¸­è‹±æ–‡å­—ç¬¦
                                    
                                    console.log(`æ¯”è¼ƒ: "${cleanFileName}" vs "${cleanStuName}" (å­¸ç”Ÿ: ${stu.name})`);
                                    
                                    // å¤šç¨®åŒ¹é…ç­–ç•¥
                                    if (cleanFileName.includes(cleanStuName)) {
                                        matchScore = cleanStuName.length * 10; // å®Œæ•´å§“ååŒ¹é…ï¼Œæœ€é«˜åˆ†
                                        matchType = 'å®Œæ•´å§“å';
                                        console.log(`  âœ“ å®Œæ•´å§“ååŒ¹é…: ${cleanStuName} (åˆ†æ•¸: ${matchScore})`);
                                    } else if (fileName.includes(stuName)) {
                                        matchScore = stuName.length * 8; // åŸå§‹å§“ååŒ¹é…
                                        matchType = 'åŸå§‹å§“å';
                                        console.log(`  âœ“ åŸå§‹å§“ååŒ¹é…: ${stuName} (åˆ†æ•¸: ${matchScore})`);
                                    } else if (fileName.includes(stuName.replace(/\s+/g, ''))) {
                                        matchScore = stuName.replace(/\s+/g, '').length * 6; // ç„¡ç©ºæ ¼åŒ¹é…
                                        matchType = 'ç„¡ç©ºæ ¼å§“å';
                                        console.log(`  âœ“ ç„¡ç©ºæ ¼å§“ååŒ¹é…: ${stuName.replace(/\s+/g, '')} (åˆ†æ•¸: ${matchScore})`);
                                    } else if (fileName.includes(stuName.replace(/[^\u4e00-\u9fa5]/g, ''))) {
                                        matchScore = stuName.replace(/[^\u4e00-\u9fa5]/g, '').length * 4; // åªä¸­æ–‡å­—ç¬¦åŒ¹é…
                                        matchType = 'ä¸­æ–‡å­—ç¬¦';
                                        console.log(`  âœ“ ä¸­æ–‡å­—ç¬¦åŒ¹é…: ${stuName.replace(/[^\u4e00-\u9fa5]/g, '')} (åˆ†æ•¸: ${matchScore})`);
                                    } else if (cleanStuName.length <= 4 && cleanFileName.includes(cleanStuName)) {
                                        // çŸ­è‹±æ–‡å§“åç‰¹æ®Šè™•ç†ï¼ˆå¦‚ Ali, Alvinï¼‰
                                        matchScore = cleanStuName.length * 12; // çŸ­è‹±æ–‡å§“åæœ€é«˜åˆ†
                                        matchType = 'çŸ­è‹±æ–‡å§“å';
                                        console.log(`  âœ“ çŸ­è‹±æ–‡å§“ååŒ¹é…: ${cleanStuName} (åˆ†æ•¸: ${matchScore})`);
                                    } else if (cleanStuName.length <= 4 && fileName.toLowerCase().includes(cleanStuName.toLowerCase())) {
                                        // çŸ­è‹±æ–‡å§“åä¸å€åˆ†å¤§å°å¯«åŒ¹é…
                                        matchScore = cleanStuName.length * 11;
                                        matchType = 'çŸ­è‹±æ–‡å§“å(ä¸å€åˆ†å¤§å°å¯«)';
                                        console.log(`  âœ“ çŸ­è‹±æ–‡å§“å(ä¸å€åˆ†å¤§å°å¯«)åŒ¹é…: ${cleanStuName} (åˆ†æ•¸: ${matchScore})`);
                                    } else {
                                        // å˜—è©¦éƒ¨åˆ†åŒ¹é…ï¼ˆè‡³å°‘2å€‹å­—ç¬¦ï¼Œå°è‹±æ–‡å§“åæ›´å¯¬é¬†ï¼‰
                                        const minLength = cleanStuName.length <= 4 ? 2 : 3;
                                        for (let i = minLength; i <= cleanStuName.length; i++) {
                                            for (let j = 0; j <= cleanStuName.length - i; j++) {
                                                const part = cleanStuName.substring(j, j + i);
                                                if (cleanFileName.includes(part)) {
                                                    const score = part.length * 2;
                                                    if (score > matchScore) {
                                                        matchScore = score;
                                                        matchType = `éƒ¨åˆ†åŒ¹é…(${part})`;
                                                        console.log(`  âœ“ éƒ¨åˆ†åŒ¹é…: ${part} (åˆ†æ•¸: ${score})`);
                                                    }
                                                }
                                            }
                                        }
                                    }
                                    
                                    // å¦‚æœæ‰¾åˆ°æ›´å¥½çš„åŒ¹é…ï¼Œæ›´æ–°æœ€ä½³åŒ¹é…
                                    if (matchScore > bestMatchScore) {
                                        bestMatchScore = matchScore;
                                        bestMatch = stu;
                                        bestMatch.matchType = matchType;
                                        console.log(`  â†’ æ›´æ–°æœ€ä½³åŒ¹é…: ${stu.name} (${matchType}, åˆ†æ•¸: ${matchScore})`);
                                    }
                                }
                            });
                        });
                        
                        if (bestMatch && bestMatchScore > 0) {
                            console.log(`åŒ¹é…æˆåŠŸ: ${fileName} â†’ ${bestMatch.name} (${bestMatch.matchType}, åˆ†æ•¸: ${bestMatchScore})`);
                            bestMatch.photo = e.target.result;
                            matched++;
                        } else {
                            console.log(`ç„¡æ³•åŒ¹é…: ${fileName}`);
                            unmatchedFiles.push(file.name);
                        }
                        
                        processedCount++;
                        
                        // æ›´æ–°è™•ç†é€²åº¦
                        const processingDiv = document.getElementById('processingDiv');
                        if (processingDiv) {
                            processingDiv.innerHTML = `
                                <div class="alert alert-info text-center">
                                    <i class="fas fa-spinner fa-spin me-2"></i>æ­£åœ¨è™•ç† ${imageFiles.length} å€‹æª”æ¡ˆ... (${processedCount}/${imageFiles.length})
                                </div>
                                <div class="mt-2">
                                    <small class="text-muted">æª”æ¡ˆåç¨±æ¸…ç†ç¯„ä¾‹ï¼š</small><br>
                                    <small class="text-muted">IMG_001_è¶™é–æ˜•.jpg â†’ è¶™é–æ˜•</small><br>
                                    <small class="text-muted">photo-ç¾…è«­ç¦-2024.jpg â†’ ç¾…è«­ç¦</small>
                                </div>
                            `;
                        }
                        
                        // æ‰€æœ‰æª”æ¡ˆè™•ç†å®Œæˆ
                        if (processedCount === imageFiles.length) {
                            // ç§»é™¤è™•ç†æç¤º
                            const processingDiv = document.getElementById('processingDiv');
                            if (processingDiv) {
                                processingDiv.remove();
                            }
                            
                            // å„²å­˜ä¸¦é‡æ–°æ¸²æŸ“
                            saveStudentPhotos();
                            renderStudentGrid();
                            
                            // é¡¯ç¤ºçµæœ
                            let message = `è™•ç†å®Œæˆï¼\næˆåŠŸåŒ¹é…: ${matched} å¼µç›¸ç‰‡`;
                            if (unmatchedFiles.length > 0) {
                                message += `\nç„¡æ³•åŒ¹é…: ${unmatchedFiles.length} å€‹æª”æ¡ˆ`;
                                message += `\n\nç„¡æ³•åŒ¹é…çš„æª”æ¡ˆï¼š\n${unmatchedFiles.join('\n')}`;
                            }
                            
                            alert(message);
                        }
                        
                    } catch (error) {
                        console.error('è™•ç†æª”æ¡ˆæ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
                        errors.push(file.name);
                        processedCount++;
                        
                        if (processedCount === imageFiles.length) {
                            const processingDiv = document.getElementById('processingDiv');
                            if (processingDiv) {
                                processingDiv.remove();
                            }
                            
                            if (errors.length > 0) {
                                alert(`è™•ç†å®Œæˆï¼Œä½†æœ‰ ${errors.length} å€‹æª”æ¡ˆç™¼ç”ŸéŒ¯èª¤ï¼š\n${errors.join('\n')}`);
                            }
                        }
                    }
                };
                
                reader.onerror = function() {
                    console.error('è®€å–æª”æ¡ˆå¤±æ•—:', file.name);
                    errors.push(file.name);
                    processedCount++;
                    
                    if (processedCount === imageFiles.length) {
                        const processingDiv = document.getElementById('processingDiv');
                        if (processingDiv) {
                            processingDiv.remove();
                        }
                        
                        if (errors.length > 0) {
                            alert(`è™•ç†å®Œæˆï¼Œä½†æœ‰ ${errors.length} å€‹æª”æ¡ˆç™¼ç”ŸéŒ¯èª¤ï¼š\n${errors.join('\n')}`);
                        }
                    }
                };
                
                reader.readAsDataURL(file);
            });
        }
        function updatePhotoStats() {
            let totalStudents = 0;
            let studentsWithPhotos = 0;
            
            studentsData.forEach(cls => {
                cls.students.forEach(student => {
                    totalStudents++;
                    if (student.photo && student.photo !== '') {
                        studentsWithPhotos++;
                    }
                });
            });
            
            const statsElement = document.getElementById('photoStats');
            const percentage = Math.round((studentsWithPhotos / totalStudents) * 100);
            statsElement.innerHTML = `<i class="fas fa-camera me-2"></i>${studentsWithPhotos}/${totalStudents} å­¸ç”Ÿå·²æœ‰ç›¸ç‰‡ (${percentage}%)`;
            
            // æ ¹æ“šå®Œæˆåº¦æ”¹è®Šé¡è‰²
            if (percentage >= 80) {
                statsElement.className = 'badge bg-success fs-6';
            } else if (percentage >= 50) {
                statsElement.className = 'badge bg-warning fs-6';
            } else {
                statsElement.className = 'badge bg-danger fs-6';
            }
        }
        
        function renderStudentGrid() {
            const grid = document.getElementById('studentGrid');
            let html = '';
            studentsData.forEach(cls => {
                cls.students.forEach(student => {
                    const hasPhoto = student.photo && student.photo !== '';
                    html += `
                        <div class="student-card" data-student-id="${student.id}">
                            <div class="student-photo ${hasPhoto ? '' : 'placeholder'}" onclick="uploadPhotoForStudent('${student.id}')">
                                ${hasPhoto ? `<img src="${student.photo}" alt="${student.name}" class="student-photo">` : `<i class="fas fa-user"></i>`}
                            </div>
                            <div class="student-name">${student.name}</div>
                            <div class="student-class">${cls.class}</div>
                        </div>
                    `;
                });
            });
            grid.innerHTML = html;
            updatePhotoStats();
        }
        function uploadPhotoForStudent(studentId) {
            const student = findStudentById(studentId);
            if (!student) {
                alert('æ‰¾ä¸åˆ°è©²å­¸ç”Ÿè³‡æ–™');
                return;
            }
            
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*';
            input.onchange = function(e) {
                const file = e.target.files[0];
                if (file) {
                    // æª¢æŸ¥æª”æ¡ˆå¤§å°ï¼ˆé™åˆ¶ç‚º 5MBï¼‰
                    if (file.size > 5 * 1024 * 1024) {
                        alert('æª”æ¡ˆå¤ªå¤§ï¼Œè«‹é¸æ“‡å°æ–¼ 5MB çš„åœ–ç‰‡æª”æ¡ˆ');
                        return;
                    }
                    
                    // æª¢æŸ¥æª”æ¡ˆé¡å‹
                    if (!file.type.startsWith('image/')) {
                        alert('è«‹é¸æ“‡åœ–ç‰‡æª”æ¡ˆ');
                        return;
                    }
                    
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        student.photo = e.target.result;
                        saveStudentPhotos();
                        renderStudentGrid();
                        console.log(`å·²ç‚º ${student.name} ä¸Šå‚³ç›¸ç‰‡`);
                    };
                    reader.onerror = function() {
                        alert('è®€å–æª”æ¡ˆæ™‚ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹é‡è©¦');
                    };
                    reader.readAsDataURL(file);
                }
            };
            input.click();
        }
        function findStudentById(id) {
            for (const cls of studentsData) {
                for (const student of cls.students) {
                    if (student.id === id) return student;
                }
            }
            return null;
        }
        function autoMatchPhotos() {
            if (uploadedFiles.length === 0) { alert('è«‹å…ˆä¸Šå‚³ç›¸ç‰‡æª”æ¡ˆ'); return; }
            let matched = 0;
            let totalToMatch = 0;
            studentsData.forEach(cls => { cls.students.forEach(student => { if (!student.photo || student.photo === '') totalToMatch++; }); });
            if (totalToMatch === 0) { alert('æ‰€æœ‰å­¸ç”Ÿéƒ½å·²æœ‰ç›¸ç‰‡ï¼'); return; }
            
            // ç‚ºæ¯å€‹æª”æ¡ˆæ‰¾åˆ°æœ€ä½³åŒ¹é…çš„å­¸ç”Ÿ
            uploadedFiles.forEach(file => {
                const fileName = file.name.toLowerCase();
                let bestMatch = null;
                let bestMatchScore = 0;
                
                studentsData.forEach(cls => {
                    cls.students.forEach(student => {
                        if (!student.photo || student.photo === '') {
                            const studentName = student.name.toLowerCase();
                            let matchScore = 0;
                            
                            // è¨ˆç®—åŒ¹é…åˆ†æ•¸
                            if (fileName.includes(studentName)) {
                                matchScore = studentName.length; // å®Œæ•´å§“ååŒ¹é…
                            } else if (fileName.includes(studentName.replace(/\s+/g, ''))) {
                                matchScore = studentName.replace(/\s+/g, '').length; // ç„¡ç©ºæ ¼åŒ¹é…
                            } else if (fileName.includes(studentName.replace(/[^\u4e00-\u9fa5]/g, ''))) {
                                matchScore = studentName.replace(/[^\u4e00-\u9fa5]/g, '').length; // åªä¸­æ–‡å­—ç¬¦åŒ¹é…
                            }
                            
                            // å¦‚æœæ‰¾åˆ°æ›´å¥½çš„åŒ¹é…ï¼Œæ›´æ–°æœ€ä½³åŒ¹é…
                            if (matchScore > bestMatchScore) {
                                bestMatchScore = matchScore;
                                bestMatch = student;
                            }
                        }
                    });
                });
                
                if (bestMatch && bestMatchScore > 0) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        bestMatch.photo = e.target.result;
                        matched++;
                        saveStudentPhotos();
                        renderStudentGrid();
                        console.log(`è‡ªå‹•åŒ¹é…æˆåŠŸï¼š${file.name} -> ${bestMatch.name} (åˆ†æ•¸: ${bestMatchScore})`);
                        
                        if (matched === totalToMatch) {
                            alert(`è‡ªå‹•åŒ¹é…å®Œæˆï¼æˆåŠŸåŒ¹é… ${matched} å¼µç›¸ç‰‡`);
                        }
                    };
                    reader.readAsDataURL(file);
                }
            });
        }
        function saveStudentPhotos() {
            try {
                localStorage.setItem('studentPhotos', JSON.stringify(studentsData));
                console.log('ç›¸ç‰‡è³‡æ–™å·²å„²å­˜åˆ° localStorage');
                
                // é¡¯ç¤ºå„²å­˜æˆåŠŸæç¤ºï¼ˆçŸ­æš«é¡¯ç¤ºï¼‰
                const saveIndicator = document.getElementById('saveIndicator') || createSaveIndicator();
                saveIndicator.style.display = 'block';
                setTimeout(() => {
                    saveIndicator.style.display = 'none';
                }, 2000);
                
            } catch (error) {
                console.error('å„²å­˜ç›¸ç‰‡è³‡æ–™å¤±æ•—:', error);
                alert('å„²å­˜å¤±æ•—ï¼è«‹æª¢æŸ¥ç€è¦½å™¨å„²å­˜ç©ºé–“æˆ–é‡æ–°æ•´ç†é é¢ã€‚');
            }
        }
        
        function createSaveIndicator() {
            const indicator = document.createElement('div');
            indicator.id = 'saveIndicator';
            indicator.innerHTML = `
                <div class="alert alert-success alert-dismissible fade show position-fixed" 
                     style="top: 20px; right: 20px; z-index: 9999; min-width: 200px;">
                    <i class="fas fa-save me-2"></i>ç›¸ç‰‡å·²è‡ªå‹•å„²å­˜
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `;
            document.body.appendChild(indicator);
            return indicator;
        }
        function loadExistingPhotos() {
            const saved = localStorage.getItem('studentPhotos');
            if (saved) {
                const savedData = JSON.parse(saved);
                // ç”¨ id å°æ‡‰åˆä½µ
                const photoMap = {};
                savedData.forEach(cls => {
                    cls.students.forEach(stu => {
                        if (stu.id && stu.photo) {
                            photoMap[stu.id] = stu.photo;
                        }
                    });
                });
                studentsData.forEach(cls => {
                    cls.students.forEach(stu => {
                        if (photoMap[stu.id]) {
                            stu.photo = photoMap[stu.id];
                        }
                    });
                });
            }
        }
        function forceSync() {
            saveStudentPhotos();
            renderStudentGrid();
            alert('å·²å¼·åˆ¶åŒæ­¥ç›¸ç‰‡è³‡æ–™ï¼\n\nè«‹åœ¨å…¶ä»–é é¢æŒ‰ F5 é‡æ–°æ•´ç†æˆ–åˆ‡æ›æ¨™ç±¤é ä¾†æŸ¥çœ‹æ›´æ–°ã€‚');
        }
        
        function clearAllPhotos() {
            if (confirm('ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰å­¸ç”Ÿçš„ç›¸ç‰‡å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸã€‚')) {
                studentsData.forEach(cls => {
                    cls.students.forEach(student => {
                        student.photo = '';
                    });
                });
                saveStudentPhotos();
                renderStudentGrid();
                alert('å·²æ¸…é™¤æ‰€æœ‰å­¸ç”Ÿç›¸ç‰‡ï¼');
            }
        }
        
        function checkDuplicatePhotos() {
            const photoMap = new Map();
            const duplicates = [];
            
            studentsData.forEach(cls => {
                cls.students.forEach(student => {
                    if (student.photo && student.photo !== '') {
                        if (photoMap.has(student.photo)) {
                            duplicates.push({
                                photo: student.photo,
                                students: [photoMap.get(student.photo), student]
                            });
                        } else {
                            photoMap.set(student.photo, student);
                        }
                    }
                });
            });
            
            if (duplicates.length > 0) {
                let message = `ç™¼ç¾ ${duplicates.length} çµ„é‡è¤‡ç›¸ç‰‡ï¼š\n\n`;
                duplicates.forEach((dup, index) => {
                    message += `${index + 1}. ç›¸ç‰‡è¢«åˆ†é…çµ¦ï¼š\n`;
                    dup.students.forEach(stu => {
                        message += `   - ${stu.name} (${stu.id})\n`;
                    });
                    message += '\n';
                });
                message += 'å»ºè­°ï¼šæ¸…é™¤æ‰€æœ‰ç›¸ç‰‡å¾Œé‡æ–°ä¸Šå‚³ï¼Œæˆ–æ‰‹å‹•ç‚ºæ¯å€‹å­¸ç”Ÿä¸Šå‚³æ­£ç¢ºçš„ç›¸ç‰‡ã€‚';
                alert(message);
            } else {
                alert('æ²’æœ‰ç™¼ç¾é‡è¤‡ç›¸ç‰‡ï¼');
            }
        }
        
        function manualSave() {
            saveStudentPhotos();
            alert('ç›¸ç‰‡è³‡æ–™å·²æ‰‹å‹•å„²å­˜ï¼');
        }
        
        function testFileNameMatching() {
            const testFileName = prompt('è«‹è¼¸å…¥è¦æ¸¬è©¦çš„æª”æ¡ˆåç¨±ï¼ˆä¾‹å¦‚ï¼šIMG_001_è¶™é–æ˜•.jpgï¼‰ï¼š');
            if (!testFileName) return;
            
            const fileName = testFileName.toLowerCase();
            let bestMatch = null;
            let bestMatchScore = 0;
            let bestMatchType = '';
            
            // æ¸…ç†æª”æ¡ˆåç¨±
            const cleanFileName = fileName
                .replace(/\.(jpg|jpeg|png|gif|bmp|webp)$/i, '')
                .replace(/^(img_|dsc_|photo_|pic_|image_)/i, '')
                .replace(/[_\-\s]+/g, '')
                .replace(/[0-9]+/g, '');
            
            studentsData.forEach(cls => {
                cls.students.forEach(stu => {
                    const stuName = stu.name.toLowerCase();
                    let matchScore = 0;
                    let matchType = '';
                    
                    // æ¸…ç†å­¸ç”Ÿå§“å
                    const cleanStuName = stuName
                        .replace(/\s+/g, '')
                        .replace(/[^\u4e00-\u9fa5a-zA-Z]/g, '');
                    
                    // å¤šç¨®åŒ¹é…ç­–ç•¥
                    if (cleanFileName.includes(cleanStuName)) {
                        matchScore = cleanStuName.length * 10;
                        matchType = 'å®Œæ•´å§“å';
                    } else if (fileName.includes(stuName)) {
                        matchScore = stuName.length * 8;
                        matchType = 'åŸå§‹å§“å';
                    } else if (fileName.includes(stuName.replace(/\s+/g, ''))) {
                        matchScore = stuName.replace(/\s+/g, '').length * 6;
                        matchType = 'ç„¡ç©ºæ ¼å§“å';
                    } else if (fileName.includes(stuName.replace(/[^\u4e00-\u9fa5]/g, ''))) {
                        matchScore = stuName.replace(/[^\u4e00-\u9fa5]/g, '').length * 4;
                        matchType = 'ä¸­æ–‡å­—ç¬¦';
                    } else if (cleanStuName.length <= 4 && cleanFileName.includes(cleanStuName)) {
                        matchScore = cleanStuName.length * 12;
                        matchType = 'çŸ­è‹±æ–‡å§“å';
                    } else if (cleanStuName.length <= 4 && fileName.toLowerCase().includes(cleanStuName.toLowerCase())) {
                        matchScore = cleanStuName.length * 11;
                        matchType = 'çŸ­è‹±æ–‡å§“å(ä¸å€åˆ†å¤§å°å¯«)';
                    } else {
                        // å˜—è©¦éƒ¨åˆ†åŒ¹é…
                        const minLength = cleanStuName.length <= 4 ? 2 : 3;
                        for (let i = minLength; i <= cleanStuName.length; i++) {
                            for (let j = 0; j <= cleanStuName.length - i; j++) {
                                const part = cleanStuName.substring(j, j + i);
                                if (cleanFileName.includes(part)) {
                                    const score = part.length * 2;
                                    if (score > matchScore) {
                                        matchScore = score;
                                        matchType = `éƒ¨åˆ†åŒ¹é…(${part})`;
                                    }
                                }
                            }
                        }
                    }
                    
                    if (matchScore > bestMatchScore) {
                        bestMatchScore = matchScore;
                        bestMatch = stu;
                        bestMatchType = matchType;
                    }
                });
            });
            
            let result = `æª”æ¡ˆåç¨±ï¼š${testFileName}\n`;
            result += `æ¸…ç†å¾Œï¼š${cleanFileName}\n\n`;
            
            if (bestMatch && bestMatchScore > 0) {
                result += `âœ… åŒ¹é…æˆåŠŸï¼\n`;
                result += `å­¸ç”Ÿï¼š${bestMatch.name}\n`;
                result += `åˆ†æ•¸ï¼š${bestMatchScore}\n`;
                result += `é¡å‹ï¼š${bestMatchType}`;
            } else {
                result += `âŒ ç„¡æ³•åŒ¹é…ä»»ä½•å­¸ç”Ÿ\n`;
                result += `å»ºè­°ï¼šç¢ºä¿æª”æ¡ˆåç¨±åŒ…å«å­¸ç”Ÿå§“å`;
            }
            
            alert(result);
        }
        
        function checkAvailableStudents() {
            let totalStudents = 0;
            let studentsWithPhotos = 0;
            let studentsWithoutPhotos = [];
            
            studentsData.forEach(cls => {
                cls.students.forEach(stu => {
                    totalStudents++;
                    if (stu.photo && stu.photo !== '') {
                        studentsWithPhotos++;
                    } else {
                        studentsWithoutPhotos.push(`${stu.name} (${cls.class})`);
                    }
                });
            });
            
            let result = `ğŸ“Š å­¸ç”Ÿç›¸ç‰‡çµ±è¨ˆ\n\n`;
            result += `ç¸½å­¸ç”Ÿæ•¸ï¼š${totalStudents}\n`;
            result += `å·²æœ‰ç›¸ç‰‡ï¼š${studentsWithPhotos}\n`;
            result += `ç¼ºå°‘ç›¸ç‰‡ï¼š${studentsWithoutPhotos.length}\n\n`;
            
            if (studentsWithoutPhotos.length > 0) {
                result += `ç¼ºå°‘ç›¸ç‰‡çš„å­¸ç”Ÿï¼š\n`;
                studentsWithoutPhotos.slice(0, 20).forEach(stu => {
                    result += `â€¢ ${stu}\n`;
                });
                if (studentsWithoutPhotos.length > 20) {
                    result += `... é‚„æœ‰ ${studentsWithoutPhotos.length - 20} å€‹å­¸ç”Ÿ`;
                }
            }
            
            alert(result);
        }
        
        function forceRematch() {
            if (confirm('ç¢ºå®šè¦å¼·åˆ¶é‡æ–°åŒ¹é…å—ï¼Ÿé€™æœƒæ¸…é™¤æ‰€æœ‰ç¾æœ‰ç›¸ç‰‡ä¸¦é‡æ–°åˆ†é…ã€‚')) {
                // æ¸…é™¤æ‰€æœ‰ç›¸ç‰‡
                studentsData.forEach(cls => {
                    cls.students.forEach(stu => {
                        stu.photo = '';
                    });
                });
                
                saveStudentPhotos();
                renderStudentGrid();
                alert('å·²æ¸…é™¤æ‰€æœ‰ç›¸ç‰‡ï¼ç¾åœ¨å¯ä»¥é‡æ–°ä¸Šå‚³æª”æ¡ˆé€²è¡ŒåŒ¹é…ã€‚');
            }
        }
        
        // PWA ç›¸é—œåŠŸèƒ½
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js')
                    .then(registration => {
                        console.log('Service Worker è¨»å†ŠæˆåŠŸ:', registration);
                    })
                    .catch(error => {
                        console.log('Service Worker è¨»å†Šå¤±æ•—:', error);
                    });
            });
        }
    </script>
</body>
</html>