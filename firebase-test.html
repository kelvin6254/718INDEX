<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Firebase æ•´åˆæ¸¬è©¦</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { padding: 20px; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 8px; }
        .success { background-color: #d4edda; border-color: #c3e6cb; }
        .error { background-color: #f8d7da; border-color: #f5c6cb; }
        .info { background-color: #d1ecf1; border-color: #bee5eb; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Firebase æ•´åˆæ¸¬è©¦</h1>
        
        <div class="test-section info">
            <h3>ğŸ“‹ æ¸¬è©¦èªªæ˜</h3>
            <p>æ­¤é é¢ç”¨æ–¼æ¸¬è©¦ Firebase æ•´åˆåŠŸèƒ½æ˜¯å¦æ­£å¸¸é‹ä½œã€‚</p>
        </div>
        
        <div class="test-section">
            <h3>ğŸ”§ Firebase é€£æ¥æ¸¬è©¦</h3>
            <button class="btn btn-primary" onclick="testFirebaseConnection()">æ¸¬è©¦é€£æ¥</button>
            <div id="connectionResult"></div>
        </div>
        
        <div class="test-section">
            <h3>ğŸ“ æˆç¸¾åŒæ­¥æ¸¬è©¦</h3>
            <button class="btn btn-success" onclick="testScoreSync()">æ¸¬è©¦æˆç¸¾åŒæ­¥</button>
            <div id="syncResult"></div>
        </div>
        
        <div class="test-section">
            <h3>ğŸ“Š æˆç¸¾è¼‰å…¥æ¸¬è©¦</h3>
            <button class="btn btn-info" onclick="testScoreLoad()">è¼‰å…¥æˆç¸¾</button>
            <div id="loadResult"></div>
        </div>
        
        <div class="test-section">
            <h3>ğŸ”— å¿«é€Ÿé€£çµ</h3>
            <a href="index.html" class="btn btn-outline-primary">è¿”å›é¦–é </a>
            <a href="student-zone.html?id=001" class="btn btn-outline-secondary">å­¸ç”Ÿå°ˆå€æ¸¬è©¦</a>
        </div>
    </div>

    <script src="js/firebase-config.js"></script>
    <script type="module">
        import { db, storage } from './js/firebase.js';
        import { collection, getDocs, doc, setDoc, serverTimestamp } from 'https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js';
        
        // æ¸¬è©¦ Firebase é€£æ¥
        window.testFirebaseConnection = async function() {
            const resultDiv = document.getElementById('connectionResult');
            resultDiv.innerHTML = '<div class="alert alert-info">æ­£åœ¨æ¸¬è©¦é€£æ¥...</div>';
            
            try {
                const testRef = doc(db, 'test', 'connection');
                await setDoc(testRef, {
                    timestamp: serverTimestamp(),
                    message: 'é€£æ¥æ¸¬è©¦æˆåŠŸ'
                });
                
                resultDiv.innerHTML = '<div class="alert alert-success">âœ… Firebase é€£æ¥æˆåŠŸï¼</div>';
            } catch (error) {
                resultDiv.innerHTML = `<div class="alert alert-danger">âŒ é€£æ¥å¤±æ•—ï¼š${error.message}</div>`;
            }
        };
        
        // æ¸¬è©¦æˆç¸¾åŒæ­¥
        window.testScoreSync = async function() {
            const resultDiv = document.getElementById('syncResult');
            resultDiv.innerHTML = '<div class="alert alert-info">æ­£åœ¨æ¸¬è©¦æˆç¸¾åŒæ­¥...</div>';
            
            try {
                const testScore = {
                    name: 'æ¸¬è©¦å­¸ç”Ÿ',
                    front: 50,
                    jack: 45,
                    ski: 40,
                    bike: 35,
                    cross: 30,
                    crossOpen: 25,
                    double: 20,
                    total: 245,
                    date: new Date().toISOString().split('T')[0]
                };
                
                // åŒæ­¥åˆ° Firebase
                const studentRef = doc(db, 'students', testScore.name);
                await setDoc(studentRef, {
                    name: testScore.name,
                    updatedAt: serverTimestamp()
                }, { merge: true });
                
                const scoreRef = doc(db, 'students', testScore.name, 'scores', testScore.date);
                await setDoc(scoreRef, {
                    front: testScore.front,
                    jack: testScore.jack,
                    ski: testScore.ski,
                    bike: testScore.bike,
                    cross: testScore.cross,
                    crossOpen: testScore.crossOpen,
                    double: testScore.double,
                    total: testScore.total,
                    date: testScore.date,
                    updatedAt: serverTimestamp()
                });
                
                resultDiv.innerHTML = '<div class="alert alert-success">âœ… æˆç¸¾åŒæ­¥æ¸¬è©¦æˆåŠŸï¼</div>';
            } catch (error) {
                resultDiv.innerHTML = `<div class="alert alert-danger">âŒ åŒæ­¥å¤±æ•—ï¼š${error.message}</div>`;
            }
        };
        
        // æ¸¬è©¦æˆç¸¾è¼‰å…¥
        window.testScoreLoad = async function() {
            const resultDiv = document.getElementById('loadResult');
            resultDiv.innerHTML = '<div class="alert alert-info">æ­£åœ¨è¼‰å…¥æˆç¸¾...</div>';
            
            try {
                const studentsRef = collection(db, 'students');
                const snapshot = await getDocs(studentsRef);
                let totalScores = 0;
                
                for (const studentDoc of snapshot.docs) {
                    const studentData = studentDoc.data();
                    const scoresRef = collection(db, 'students', studentDoc.id, 'scores');
                    const scoresSnapshot = await getDocs(scoresRef);
                    totalScores += scoresSnapshot.size;
                }
                
                resultDiv.innerHTML = `<div class="alert alert-success">âœ… è¼‰å…¥æˆåŠŸï¼å…±æ‰¾åˆ° ${snapshot.size} ä½å­¸ç”Ÿï¼Œ${totalScores} ç­†æˆç¸¾è¨˜éŒ„ã€‚</div>`;
            } catch (error) {
                resultDiv.innerHTML = `<div class="alert alert-danger">âŒ è¼‰å…¥å¤±æ•—ï¼š${error.message}</div>`;
            }
        };
    </script>
</body>
</html>
