<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>雲端學生清單（Firebase）</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    .student-card { cursor: pointer; transition: transform .1s ease; }
    .student-card:hover { transform: translateY(-2px); }
    .avatar { width: 48px; height: 48px; object-fit: cover; border-radius: 50%; background: #f2f2f2; }
  </style>
  <link rel="manifest" href="manifest.json" />
  <meta name="theme-color" content="#2339d6" />
  <link rel="icon" href="favicon.ico" />
  <meta name="description" content="從 Firebase 顯示雲端學生清單（只讀檢視）" />
</head>
<body class="bg-light">
  <div class="container py-4">
    <div class="d-flex align-items-center justify-content-between mb-3">
      <h2 class="fw-bold m-0" style="color:#2339d6;letter-spacing:1px;">雲端學生清單（Firebase）</h2>
      <a class="btn btn-secondary" href="index.html">返回首頁</a>
    </div>

    <div class="card shadow-sm mb-3">
      <div class="card-body">
        <div class="row g-3 align-items-center">
          <div class="col-md-6">
            <input id="search" class="form-control" placeholder="搜尋姓名或班級..." />
          </div>
          <div class="col-md-6 text-md-end small text-muted">
            <span id="status">初始化中...</span>
          </div>
        </div>
      </div>
    </div>

    <div id="list" class="row g-3"></div>
  </div>

  <script src="js/firebase-config.js"></script>
  <script type="module">
    import { ensureAuth, listenStudents } from './js/firebase.js';

    const statusEl = document.getElementById('status');
    const listEl = document.getElementById('list');
    const searchEl = document.getElementById('search');

    let students = [];
    function render(filter = '') {
      const q = (filter || '').trim().toLowerCase();
      listEl.innerHTML = '';
      const filtered = students.filter(s => {
        const n = (s.name || '').toLowerCase();
        const c = (s.class || '').toLowerCase();
        return !q || n.includes(q) || c.includes(q);
      });
      if (filtered.length === 0) {
        listEl.innerHTML = '<div class="col-12 text-muted">沒有資料，請先用匯入頁寫入 Firestore。</div>';
        return;
      }
      for (const s of filtered) {
        const safeName = encodeURIComponent(s.name || '');
        const col = document.createElement('div');
        col.className = 'col-12 col-md-6 col-lg-4';
        col.innerHTML = `
          <a class="text-decoration-none text-reset" href="cloud-student?id=${s.id}">
            <div class="student-card card shadow-sm">
              <div class="card-body d-flex align-items-center gap-3">
                <img class="avatar" src="${s.photoUrl || `PIC/${safeName}.jpg`}" onerror="if(!this.dataset.fallback){this.dataset.fallback='1';this.src='PIC/${safeName}.jpg';}else{this.src='';this.style.background='#e9ecef';}" alt="avatar">
                <div>
                  <div class="fw-bold">${s.name || '未命名'}</div>
                  <div class="text-muted small">${s.class || '未分班'}</div>
                </div>
              </div>
            </div>
          </a>
        `;
        listEl.appendChild(col);
      }
    }

    (async () => {
      try {
        statusEl.textContent = '登入中...';
        await ensureAuth();
        statusEl.textContent = '已登入，讀取雲端清單...';
        listenStudents(list => {
          students = list;
          statusEl.textContent = `已載入 ${students.length} 位學生`;
          render(searchEl.value);
        });
      } catch (e) {
        statusEl.textContent = '載入失敗：' + e.message;
      }
    })();

    searchEl.addEventListener('input', () => render(searchEl.value));
  </script>
</body>
</html>


