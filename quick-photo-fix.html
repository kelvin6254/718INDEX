<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>快速修復相片同步</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    .log-area {
      background: #000;
      color: #00ff00;
      font-family: monospace;
      padding: 10px;
      border-radius: 4px;
      max-height: 400px;
      overflow-y: auto;
      font-size: 12px;
    }
    .photo-preview {
      width: 80px;
      height: 80px;
      object-fit: cover;
      border-radius: 8px;
      border: 2px solid #ddd;
    }
  </style>
</head>
<body class="bg-light">
  <div class="container py-4">
    <h2 class="mb-4">
      <i class="fas fa-wrench me-2"></i>快速修復相片同步
    </h2>
    
    <div class="alert alert-info">
      <h5>問題診斷</h5>
      <p>已修復 Firebase Storage Bucket 配置問題：</p>
      <ul>
        <li><strong>修正前：</strong> holystrideeduhk.appspot.com</li>
        <li><strong>修正後：</strong> holystrideeduhk.firebasestorage.app</li>
      </ul>
    </div>

    <div class="card mb-4">
      <div class="card-header">
        <h5 class="mb-0">快速修復操作</h5>
      </div>
      <div class="card-body">
        <div class="row">
          <div class="col-md-6">
            <button id="testConnectionBtn" class="btn btn-primary w-100 mb-2">
              <i class="fas fa-wifi me-1"></i>測試連接
            </button>
          </div>
          <div class="col-md-6">
            <button id="fixAllPhotosBtn" class="btn btn-success w-100 mb-2">
              <i class="fas fa-magic me-1"></i>修復所有相片
            </button>
          </div>
        </div>
        <div class="row">
          <div class="col-md-6">
            <button id="checkStudentsBtn" class="btn btn-info w-100 mb-2">
              <i class="fas fa-users me-1"></i>檢查學生資料
            </button>
          </div>
          <div class="col-md-6">
            <button id="goToListBtn" class="btn btn-warning w-100 mb-2">
              <i class="fas fa-list me-1"></i>前往學生名單
            </button>
          </div>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="card-header">
        <h5 class="mb-0">修復日誌</h5>
      </div>
      <div class="card-body">
        <div id="log" class="log-area"></div>
        <button id="clearLogBtn" class="btn btn-outline-secondary mt-2">清除日誌</button>
      </div>
    </div>
  </div>

  <script src="js/firebase-config.js"></script>
  <script type="module">
    import { ensureAuth, db, storage } from './js/firebase.js';
    import { collection, getDocs, doc, updateDoc, serverTimestamp } from 'https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js';
    import { ref, listAll, getDownloadURL } from 'https://www.gstatic.com/firebasejs/10.12.5/firebase-storage.js';

    const logEl = document.getElementById('log');

    function log(msg, type = 'info') {
      const timestamp = new Date().toLocaleTimeString();
      const color = type === 'error' ? '#ff6b6b' : type === 'success' ? '#51cf66' : '#00ff00';
      logEl.innerHTML += `<div style="color: ${color}">[${timestamp}] ${msg}</div>`;
      logEl.scrollTop = logEl.scrollHeight;
    }

    // 測試連接
    async function testConnection() {
      try {
        log('開始測試 Firebase 連接...');
        
        if (!window.FIREBASE_CONFIG) {
          log('❌ Firebase 配置未找到', 'error');
          return;
        }
        
        log(`✅ Firebase 配置找到`);
        log(`專案 ID: ${window.FIREBASE_CONFIG.projectId}`);
        log(`Storage Bucket: ${window.FIREBASE_CONFIG.storageBucket}`);
        
        await ensureAuth();
        log('✅ Firebase 認證成功');
        
        // 測試 Storage 連接
        const storageRef = ref(storage, 'students/');
        const result = await listAll(storageRef);
        log(`✅ Storage 連接成功，找到 ${result.items.length} 個檔案`);
        
        // 顯示前幾個檔案
        for (let i = 0; i < Math.min(5, result.items.length); i++) {
          const item = result.items[i];
          log(`  - ${item.name}`);
        }
        
        if (result.items.length > 5) {
          log(`  ... 還有 ${result.items.length - 5} 個檔案`);
        }
        
        log('✅ 所有連接測試通過！', 'success');
        
      } catch (error) {
        log(`❌ 連接測試失敗: ${error.message}`, 'error');
      }
    }

    // 修復所有相片
    async function fixAllPhotos() {
      try {
        log('開始修復所有相片同步...');
        
        await ensureAuth();
        
        // 1. 獲取所有學生
        const studentsSnap = await getDocs(collection(db, 'students'));
        const students = studentsSnap.docs.map(d => ({ id: d.id, ...d.data() }));
        
        log(`找到 ${students.length} 名學生`);
        
        // 2. 掃描 Storage 中的相片
        const storageRef = ref(storage, 'students/');
        const result = await listAll(storageRef);
        const storageFiles = result.items.map(item => item.name);
        
        log(`Storage 中找到 ${storageFiles.length} 個檔案`);
        
        let fixed = 0;
        let errors = 0;
        
        // 3. 為每個學生尋找相片
        for (const student of students) {
          try {
            // 尋找匹配的相片檔案
            const photoFile = storageFiles.find(file => {
              const fileName = file.replace(/\.[^.]+$/, ''); // 移除副檔名
              return fileName === student.name;
            });
            
            if (photoFile) {
              // 更新 Firestore
              const photoUrl = await getDownloadURL(ref(storage, `students/${photoFile}`));
              
              await updateDoc(doc(db, 'students', student.id), {
                photoUrl: photoUrl,
                photoPath: `students/${photoFile}`,
                photoUpdatedAt: serverTimestamp()
              });
              
              log(`✅ 已修復 ${student.name} 的相片: ${photoFile}`, 'success');
              fixed++;
            } else {
              log(`⚠️ ${student.name} 在 Storage 中找不到相片`);
            }
          } catch (error) {
            log(`❌ 修復 ${student.name} 失敗: ${error.message}`, 'error');
            errors++;
          }
        }
        
        log(`🎉 修復完成！成功 ${fixed}，失敗 ${errors}`, 'success');
        
        // 顯示修復結果
        const resultHtml = `
          <div class="alert alert-success mt-3">
            <h6>修復結果</h6>
            <p>成功修復: ${fixed} 名學生</p>
            <p>修復失敗: ${errors} 名學生</p>
            <p>總學生數: ${students.length} 名</p>
          </div>
        `;
        
        // 在日誌區域上方插入結果
        const resultDiv = document.createElement('div');
        resultDiv.innerHTML = resultHtml;
        logEl.parentNode.insertBefore(resultDiv, logEl);
        
      } catch (error) {
        log(`❌ 修復過程失敗: ${error.message}`, 'error');
      }
    }

    // 檢查學生資料
    async function checkStudents() {
      try {
        log('檢查學生資料...');
        
        await ensureAuth();
        const snap = await getDocs(collection(db, 'students'));
        const students = snap.docs.map(d => ({ id: d.id, ...d.data() }));
        
        const withPhoto = students.filter(s => s.photoUrl).length;
        const withoutPhoto = students.length - withPhoto;
        
        log(`學生總數: ${students.length}`);
        log(`有相片: ${withPhoto}`);
        log(`無相片: ${withoutPhoto}`);
        
        // 顯示詳細資訊
        let details = '';
        for (const student of students) {
          const status = student.photoUrl ? '✅' : '❌';
          details += `${status} ${student.name}\n`;
        }
        
        log('詳細清單:');
        log(details);
        
      } catch (error) {
        log(`❌ 檢查失敗: ${error.message}`, 'error');
      }
    }

    // 事件綁定
    document.getElementById('testConnectionBtn').onclick = testConnection;
    document.getElementById('fixAllPhotosBtn').onclick = fixAllPhotos;
    document.getElementById('checkStudentsBtn').onclick = checkStudents;
    document.getElementById('goToListBtn').onclick = () => {
      window.location.href = 'students-list.html';
    };
    document.getElementById('clearLogBtn').onclick = () => {
      logEl.innerHTML = '';
    };

    // 頁面載入時自動測試連接
    document.addEventListener('DOMContentLoaded', () => {
      log('頁面載入完成，Firebase 配置已修正');
      log('Storage Bucket: holystrideeduhk.firebasestorage.app');
      log('請點擊「測試連接」開始修復流程');
    });
  </script>
</body>
</html>
