<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å¿«é€Ÿä¿®å¾©ç›¸ç‰‡åŒæ­¥</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    .log-area {
      background: #000;
      color: #00ff00;
      font-family: monospace;
      padding: 10px;
      border-radius: 4px;
      max-height: 400px;
      overflow-y: auto;
      font-size: 12px;
    }
    .photo-preview {
      width: 80px;
      height: 80px;
      object-fit: cover;
      border-radius: 8px;
      border: 2px solid #ddd;
    }
  </style>
</head>
<body class="bg-light">
  <div class="container py-4">
    <h2 class="mb-4">
      <i class="fas fa-wrench me-2"></i>å¿«é€Ÿä¿®å¾©ç›¸ç‰‡åŒæ­¥
    </h2>
    
    <div class="alert alert-info">
      <h5>å•é¡Œè¨ºæ–·</h5>
      <p>å·²ä¿®å¾© Firebase Storage Bucket é…ç½®å•é¡Œï¼š</p>
      <ul>
        <li><strong>ä¿®æ­£å‰ï¼š</strong> holystrideeduhk.appspot.com</li>
        <li><strong>ä¿®æ­£å¾Œï¼š</strong> holystrideeduhk.firebasestorage.app</li>
      </ul>
    </div>

    <div class="card mb-4">
      <div class="card-header">
        <h5 class="mb-0">å¿«é€Ÿä¿®å¾©æ“ä½œ</h5>
      </div>
      <div class="card-body">
        <div class="row">
          <div class="col-md-6">
            <button id="testConnectionBtn" class="btn btn-primary w-100 mb-2">
              <i class="fas fa-wifi me-1"></i>æ¸¬è©¦é€£æ¥
            </button>
          </div>
          <div class="col-md-6">
            <button id="fixAllPhotosBtn" class="btn btn-success w-100 mb-2">
              <i class="fas fa-magic me-1"></i>ä¿®å¾©æ‰€æœ‰ç›¸ç‰‡
            </button>
          </div>
        </div>
        <div class="row">
          <div class="col-md-6">
            <button id="checkStudentsBtn" class="btn btn-info w-100 mb-2">
              <i class="fas fa-users me-1"></i>æª¢æŸ¥å­¸ç”Ÿè³‡æ–™
            </button>
          </div>
          <div class="col-md-6">
            <button id="goToListBtn" class="btn btn-warning w-100 mb-2">
              <i class="fas fa-list me-1"></i>å‰å¾€å­¸ç”Ÿåå–®
            </button>
          </div>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="card-header">
        <h5 class="mb-0">ä¿®å¾©æ—¥èªŒ</h5>
      </div>
      <div class="card-body">
        <div id="log" class="log-area"></div>
        <button id="clearLogBtn" class="btn btn-outline-secondary mt-2">æ¸…é™¤æ—¥èªŒ</button>
      </div>
    </div>
  </div>

  <script src="js/firebase-config.js"></script>
  <script type="module">
    import { ensureAuth, db, storage } from './js/firebase.js';
    import { collection, getDocs, doc, updateDoc, serverTimestamp } from 'https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js';
    import { ref, listAll, getDownloadURL } from 'https://www.gstatic.com/firebasejs/10.12.5/firebase-storage.js';

    const logEl = document.getElementById('log');

    function log(msg, type = 'info') {
      const timestamp = new Date().toLocaleTimeString();
      const color = type === 'error' ? '#ff6b6b' : type === 'success' ? '#51cf66' : '#00ff00';
      logEl.innerHTML += `<div style="color: ${color}">[${timestamp}] ${msg}</div>`;
      logEl.scrollTop = logEl.scrollHeight;
    }

    // æ¸¬è©¦é€£æ¥
    async function testConnection() {
      try {
        log('é–‹å§‹æ¸¬è©¦ Firebase é€£æ¥...');
        
        if (!window.FIREBASE_CONFIG) {
          log('âŒ Firebase é…ç½®æœªæ‰¾åˆ°', 'error');
          return;
        }
        
        log(`âœ… Firebase é…ç½®æ‰¾åˆ°`);
        log(`å°ˆæ¡ˆ ID: ${window.FIREBASE_CONFIG.projectId}`);
        log(`Storage Bucket: ${window.FIREBASE_CONFIG.storageBucket}`);
        
        await ensureAuth();
        log('âœ… Firebase èªè­‰æˆåŠŸ');
        
        // æ¸¬è©¦ Storage é€£æ¥
        const storageRef = ref(storage, 'students/');
        const result = await listAll(storageRef);
        log(`âœ… Storage é€£æ¥æˆåŠŸï¼Œæ‰¾åˆ° ${result.items.length} å€‹æª”æ¡ˆ`);
        
        // é¡¯ç¤ºå‰å¹¾å€‹æª”æ¡ˆ
        for (let i = 0; i < Math.min(5, result.items.length); i++) {
          const item = result.items[i];
          log(`  - ${item.name}`);
        }
        
        if (result.items.length > 5) {
          log(`  ... é‚„æœ‰ ${result.items.length - 5} å€‹æª”æ¡ˆ`);
        }
        
        log('âœ… æ‰€æœ‰é€£æ¥æ¸¬è©¦é€šéï¼', 'success');
        
      } catch (error) {
        log(`âŒ é€£æ¥æ¸¬è©¦å¤±æ•—: ${error.message}`, 'error');
      }
    }

    // ä¿®å¾©æ‰€æœ‰ç›¸ç‰‡
    async function fixAllPhotos() {
      try {
        log('é–‹å§‹ä¿®å¾©æ‰€æœ‰ç›¸ç‰‡åŒæ­¥...');
        
        await ensureAuth();
        
        // 1. ç²å–æ‰€æœ‰å­¸ç”Ÿ
        const studentsSnap = await getDocs(collection(db, 'students'));
        const students = studentsSnap.docs.map(d => ({ id: d.id, ...d.data() }));
        
        log(`æ‰¾åˆ° ${students.length} åå­¸ç”Ÿ`);
        
        // 2. æƒæ Storage ä¸­çš„ç›¸ç‰‡
        const storageRef = ref(storage, 'students/');
        const result = await listAll(storageRef);
        const storageFiles = result.items.map(item => item.name);
        
        log(`Storage ä¸­æ‰¾åˆ° ${storageFiles.length} å€‹æª”æ¡ˆ`);
        
        let fixed = 0;
        let errors = 0;
        
        // 3. ç‚ºæ¯å€‹å­¸ç”Ÿå°‹æ‰¾ç›¸ç‰‡
        for (const student of students) {
          try {
            // å°‹æ‰¾åŒ¹é…çš„ç›¸ç‰‡æª”æ¡ˆ
            const photoFile = storageFiles.find(file => {
              const fileName = file.replace(/\.[^.]+$/, ''); // ç§»é™¤å‰¯æª”å
              return fileName === student.name;
            });
            
            if (photoFile) {
              // æ›´æ–° Firestore
              const photoUrl = await getDownloadURL(ref(storage, `students/${photoFile}`));
              
              await updateDoc(doc(db, 'students', student.id), {
                photoUrl: photoUrl,
                photoPath: `students/${photoFile}`,
                photoUpdatedAt: serverTimestamp()
              });
              
              log(`âœ… å·²ä¿®å¾© ${student.name} çš„ç›¸ç‰‡: ${photoFile}`, 'success');
              fixed++;
            } else {
              log(`âš ï¸ ${student.name} åœ¨ Storage ä¸­æ‰¾ä¸åˆ°ç›¸ç‰‡`);
            }
          } catch (error) {
            log(`âŒ ä¿®å¾© ${student.name} å¤±æ•—: ${error.message}`, 'error');
            errors++;
          }
        }
        
        log(`ğŸ‰ ä¿®å¾©å®Œæˆï¼æˆåŠŸ ${fixed}ï¼Œå¤±æ•— ${errors}`, 'success');
        
        // é¡¯ç¤ºä¿®å¾©çµæœ
        const resultHtml = `
          <div class="alert alert-success mt-3">
            <h6>ä¿®å¾©çµæœ</h6>
            <p>æˆåŠŸä¿®å¾©: ${fixed} åå­¸ç”Ÿ</p>
            <p>ä¿®å¾©å¤±æ•—: ${errors} åå­¸ç”Ÿ</p>
            <p>ç¸½å­¸ç”Ÿæ•¸: ${students.length} å</p>
          </div>
        `;
        
        // åœ¨æ—¥èªŒå€åŸŸä¸Šæ–¹æ’å…¥çµæœ
        const resultDiv = document.createElement('div');
        resultDiv.innerHTML = resultHtml;
        logEl.parentNode.insertBefore(resultDiv, logEl);
        
      } catch (error) {
        log(`âŒ ä¿®å¾©éç¨‹å¤±æ•—: ${error.message}`, 'error');
      }
    }

    // æª¢æŸ¥å­¸ç”Ÿè³‡æ–™
    async function checkStudents() {
      try {
        log('æª¢æŸ¥å­¸ç”Ÿè³‡æ–™...');
        
        await ensureAuth();
        const snap = await getDocs(collection(db, 'students'));
        const students = snap.docs.map(d => ({ id: d.id, ...d.data() }));
        
        const withPhoto = students.filter(s => s.photoUrl).length;
        const withoutPhoto = students.length - withPhoto;
        
        log(`å­¸ç”Ÿç¸½æ•¸: ${students.length}`);
        log(`æœ‰ç›¸ç‰‡: ${withPhoto}`);
        log(`ç„¡ç›¸ç‰‡: ${withoutPhoto}`);
        
        // é¡¯ç¤ºè©³ç´°è³‡è¨Š
        let details = '';
        for (const student of students) {
          const status = student.photoUrl ? 'âœ…' : 'âŒ';
          details += `${status} ${student.name}\n`;
        }
        
        log('è©³ç´°æ¸…å–®:');
        log(details);
        
      } catch (error) {
        log(`âŒ æª¢æŸ¥å¤±æ•—: ${error.message}`, 'error');
      }
    }

    // äº‹ä»¶ç¶å®š
    document.getElementById('testConnectionBtn').onclick = testConnection;
    document.getElementById('fixAllPhotosBtn').onclick = fixAllPhotos;
    document.getElementById('checkStudentsBtn').onclick = checkStudents;
    document.getElementById('goToListBtn').onclick = () => {
      window.location.href = 'students-list.html';
    };
    document.getElementById('clearLogBtn').onclick = () => {
      logEl.innerHTML = '';
    };

    // é é¢è¼‰å…¥æ™‚è‡ªå‹•æ¸¬è©¦é€£æ¥
    document.addEventListener('DOMContentLoaded', () => {
      log('é é¢è¼‰å…¥å®Œæˆï¼ŒFirebase é…ç½®å·²ä¿®æ­£');
      log('Storage Bucket: holystrideeduhk.firebasestorage.app');
      log('è«‹é»æ“Šã€Œæ¸¬è©¦é€£æ¥ã€é–‹å§‹ä¿®å¾©æµç¨‹');
    });
  </script>
</body>
</html>
